<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOTAM 처리 결과 - Smart NOTAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .translation-text {
            white-space: normal;
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
            word-wrap: break-word;
            padding: 10px;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            padding: 1rem;
            background-color: #fff;
        }
        .card-header-tabs {
            margin-bottom: -1px;
        }
        .badge {
            margin-left: 10px;
        }
        .time-filter-controls {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .ai-analysis-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        .ai-analysis-content h4 {
            color: #28a745;
            border-bottom: 2px solid #28a745;
            padding-bottom: 8px;
        }
        .ai-analysis-content h5 {
            color: #495057;
            margin-top: 20px;
        }
        .ai-analysis-content ul {
            padding-left: 20px;
        }
        .ai-analysis-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .ai-analysis-content p {
            margin-bottom: 12px;
            line-height: 1.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>NOTAM 목록</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    새 파일 업로드
                </a>
                <button type="button" class="btn btn-success" onclick="openGoogleMaps()">
                    <i class="fas fa-map-marked-alt me-2"></i>
                    구글지도
                </button>
            </div>
        </div>
        
        <!-- 시간 필터 제어 -->
        <div class="time-filter-controls">
            <div class="row align-items-center mb-3">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">NOTAM 필터 설정</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="timeFilterSwitch">
                            <label class="form-check-label" for="timeFilterSwitch">
                                시간 필터링
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 시간 설정 카드 (항상 표시) -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">시간 필터 (로컬 시간)</h6>
                    <div class="row g-3" id="timeFilterInputs">
                        <div class="col-md-3">
                            <label class="form-label">시작 날짜</label>
                            <input type="date" class="form-control" id="startDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">종료 날짜</label>
                            <input type="date" class="form-control" id="endDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">시작 시간</label>
                            <input type="time" class="form-control" id="startTime" value="00:00">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">종료 시간</label>
                            <input type="time" class="form-control" id="endTime" value="23:59">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block w-100" id="applyFilterBtn">
                                <i class="fas fa-search"></i> 적용
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetFilterBtn">
                                <i class="fas fa-undo"></i> 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 공항 필터 섹션 -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">공항 필터</h6>
                
                <!-- 패키지별 공항 필터 -->
                {% if package_airports %}
                <div class="row">
                    {% for package_name, airports in package_airports.items() %}
                    {% if airports %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    {% if package_name == 'package1' %}
                                        Package 1
                                    {% elif package_name == 'package2' %}
                                        Package 2
                                    {% elif package_name == 'package3' %}
                                        Package 3
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-1">
                                    {% for airport in airports %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input airport-checkbox" type="checkbox" 
                                               value="{{ airport }}" id="{{ airport }}_{{ package_name }}">
                                        <label class="form-check-label" for="{{ airport }}_{{ package_name }}">
                                            {{ airport }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <!-- 기존 공항 필터 (패키지 정보가 없는 경우) -->
                <div class="row">
                    <div class="col-md-8">
                        <div id="airportFilter" class="d-flex flex-wrap gap-2">
                            <!-- 공항 체크박스들이 여기에 동적으로 추가됩니다 -->
                            <div class="text-muted">공항 목록을 로드하는 중...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllAirports">전체 선택</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllAirports">전체 해제</button>
                            <button type="button" class="btn btn-primary btn-sm" id="applyAirportFilter">필터 적용</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 공항 필터링 결과 -->
        <div class="alert alert-info" id="filterStatus">
            전체 NOTAM: {{ notams|length }}개 (시간 필터링 비활성화 - 모든 NOTAM 표시)
            {% if all_airports %}
            <br><strong>포함된 공항:</strong> 
            {% for airport in all_airports %}
                <span class="badge bg-secondary me-1">{{ airport }}</span>
            {% endfor %}
            {% endif %}
        </div>

        <!-- 루트 입력 카드 -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-route me-2"></i>루트 입력
                </h6>
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="routeInput" class="form-label">항로 입력</label>
                            <textarea class="form-control" id="routeInput" rows="3" 
                                placeholder="예: ROUTE 1: BOPTA Z51 BEDES Y711 MUGUS Y742 SALMI Q11 TACLE B591 HCN G86 KAPLI MADRU SULUX IGLEG IKELA A1 BUNT2M.RW35B"></textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column justify-content-end h-100">
                            <button type="button" class="btn btn-primary mb-2" id="analyzeRouteBtn">
                                <i class="fas fa-robot me-2"></i>AI 항로 분석
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearRouteBtn">
                                <i class="fas fa-eraser me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="routeAnalysisResult" style="display: none;">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>루트 분석 결과
                            </h6>
                            <div id="routeAnalysisContent">
                                <!-- 분석 결과가 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTAM 목록 -->
        <div id="notamContainer">
            {% for notam in notams %}
            <div class="card mb-4 notam-item" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        NOTAM #{{ loop.index }}
                        {% if notam.airport_codes %}
                            {% for airport in notam.airport_codes %}
                                <span class="badge bg-info ms-2">{{ airport }}</span>
                            {% endfor %}
                        {% elif notam.airport_code %}
                            <span class="badge bg-info ms-2">{{ notam.airport_code }}</span>
                        {% endif %}
                        <span class="badge bg-success float-end notam-status">활성</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table">
                                <tr>
                                    <th style="width: 150px;">NOTAM 번호</th>
                                    <td>{{ notam.notam_number }}</td>
                                </tr>
                                {% if notam.airport_codes %}
                                <tr>
                                    <th>관련 공항</th>
                                    <td>
                                        {% for airport in notam.airport_codes %}
                                            <span class="badge bg-primary me-1">{{ airport }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>유효시간</th>
                                    <td>{{ notam.local_time_display|default(notam.effective_time|default('N/A') ~ ' ~ ' ~ notam.expiry_time|default('N/A')) }}</td>
                                </tr>
                                <tr>
                                    <th>원문</th>
                                    <td class="preserve-linebreaks notam-text">{{ notam.original_text|default(notam.description|default(notam.raw_text))|safe }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 영어 번역 -->
                    <div class="mt-3">
                        <h6 class="text-primary mb-2">🔤 영어 번역</h6>
                        <div class="translation-text bg-light p-3 rounded preserve-linebreaks notam-text">
                            {{ notam.english_translation|default('Translation in progress...')|safe }}
                        </div>
                    </div>
                    
                    <!-- 한국어 번역 -->
                    <div class="mt-3">
                        <h6 class="text-success mb-2">🇰🇷 한국어 번역</h6>
                        <div class="translation-text bg-light p-3 rounded korean-translation notam-text">
                            {{ notam.korean_translation|default('번역 준비 중...')|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- 통합 번역/요약 탭 (화면 최하단) -->
        <div class="mt-5 mb-5">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">📋 전체 NOTAM 번역 및 요약</h4>
                    <small class="text-muted" id="summaryFilterStatus">
                        시간 필터링이 적용되면 해당 NOTAM만 표시됩니다.
                    </small>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="summaryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-korean-tab" data-bs-toggle="tab" data-bs-target="#all-korean" type="button" role="tab">
                                🇰🇷 전체 한국어 번역
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-tab" data-bs-toggle="tab" data-bs-target="#all-english" type="button" role="tab">
                                🔤 전체 영어 번역
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-korean-summary-tab" data-bs-toggle="tab" data-bs-target="#all-korean-summary" type="button" role="tab">
                                📄 전체 한국어 요약
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-summary-tab" data-bs-toggle="tab" data-bs-target="#all-english-summary" type="button" role="tab">
                                📄 전체 영어 요약
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="summaryTabContent">
                        <!-- 전체 한국어 번역 -->
                        <div class="tab-pane fade show active" id="all-korean" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-primary">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_translation|default('번역 준비 중...')|safe }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- 전체 영어 번역 -->
                        <div class="tab-pane fade" id="all-english" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-info">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_translation|default('Translation in progress...')|safe }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- 전체 한국어 요약 -->
                        <div class="tab-pane fade" id="all-korean-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-success">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_summary|default('요약 준비 중...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- 전체 영어 요약 -->
                        <div class="tab-pane fade" id="all-english-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-warning">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_summary|default('Summary in progress...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">
                SmartNOTAM &copy; 2025. SH Smart NOTAM System
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let totalNotams = {{ notams|length }};
        
        // 시간 필터 토글
        document.getElementById('timeFilterSwitch').addEventListener('change', function() {
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (this.checked) {
                // 필터링 활성화 - 카드 활성화 스타일
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                // 상태 메시지 업데이트
                document.getElementById('filterStatus').textContent = 
                    `전체 NOTAM: ${totalNotams}개 (시간 필터 설정 후 '적용' 버튼을 클릭하세요)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `시간 범위를 설정하고 '적용' 버튼을 클릭하여 필터링하세요`;
            } else {
                // 필터링 비활성화 - 카드 비활성화 스타일
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // 모든 NOTAM 표시
                showAllNotams();
            }
        });

        // 적용 버튼 이벤트
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // 초기화 버튼 이벤트
        document.getElementById('resetFilterBtn').addEventListener('click', function() {
            // 시간 입력값 초기화
            document.getElementById('startDate').value = '{{ current_date }}';
            document.getElementById('endDate').value = '{{ current_date }}';
            document.getElementById('startTime').value = '06:00';
            document.getElementById('endTime').value = '08:00';
            
            // 필터링이 켜져 있으면 적용
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // Enter 키로도 필터 적용 가능
        ['startDate', 'endDate', 'startTime', 'endTime'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('applyFilterBtn').click();
                }
            });
        });

        function applyTimeFilter() {
            if (!document.getElementById('timeFilterSwitch').checked) {
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            console.log('필터 입력값:', { startDate, endDate, startTime, endTime });

            if (!startDate || !endDate || !startTime || !endTime) {
                alert('모든 시간 필드를 입력해주세요.');
                return;
            }

            const filterStart = new Date(startDate + 'T' + startTime);
            const filterEnd = new Date(endDate + 'T' + endTime);
            
            console.log('필터 범위:', filterStart, '~', filterEnd);

            let visibleCount = 0;
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('총 NOTAM 수:', notamItems.length);

            notamItems.forEach((item, index) => {
                const effectiveTime = item.dataset.effectiveTime;
                const expiryTime = item.dataset.expiryTime;
                
                console.log(`NOTAM ${index + 1} 원본 시간:`, { 
                    effectiveTime, 
                    expiryTime,
                    hasEffective: !!effectiveTime,
                    hasExpiry: !!expiryTime,
                    isUFN: expiryTime === 'UFN'
                });
                
                let isVisible = true;
                
                // 실제 시간 필터링 로직
                if (effectiveTime && expiryTime && effectiveTime !== 'UFN' && expiryTime !== 'UFN') {
                    try {
                        // NOTAM 시간 문자열을 Date 객체로 변환
                        let notamStart, notamEnd;
                        
                        console.log(`NOTAM ${index + 1} 원본 데이터:`, { effectiveTime, expiryTime });
                        
                        // UTC 시간을 로컬 시간으로 변환하여 비교
                        if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamStart = new Date(effectiveTime);
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            // UTC 없는 ISO 형식은 UTC로 처리
                            notamStart = new Date(effectiveTime + 'Z');
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            // 2025-07-09 16:00 형식을 UTC로 처리
                            notamStart = new Date(effectiveTime.replace(' ', 'T') + ':00Z');
                        } else {
                            // 기타 형식
                            notamStart = new Date(effectiveTime);
                        }
                        
                        if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamEnd = new Date(expiryTime);
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime + 'Z');
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime.replace(' ', 'T') + ':00Z');
                        } else {
                            notamEnd = new Date(expiryTime);
                        }
                        
                        if (!isNaN(notamStart.getTime()) && !isNaN(notamEnd.getTime())) {
                            // SmartNOTAMgemini_GCR 방식: 겹침 확인
                            // 겹치는 조건: notamStart <= filterEnd && notamEnd >= filterStart
                            const isOverlapping = notamStart <= filterEnd && notamEnd >= filterStart;
                            isVisible = isOverlapping;
                            
                            console.log(`NOTAM ${index + 1} 시간 분석 (로컬):`, {
                                notamStart: notamStart.toLocaleString(),
                                notamEnd: notamEnd.toLocaleString(),
                                filterStart: filterStart.toLocaleString(),
                                filterEnd: filterEnd.toLocaleString(),
                                isOverlapping: isOverlapping,
                                visible: isVisible
                            });
                        } else {
                            console.warn(`NOTAM ${index + 1} 시간 파싱 실패:`, {
                                effectiveTime,
                                expiryTime,
                                notamStart: isNaN(notamStart.getTime()) ? 'Invalid' : notamStart.toISOString(),
                                notamEnd: isNaN(notamEnd.getTime()) ? 'Invalid' : notamEnd.toISOString()
                            });
                            isVisible = true;  // 파싱 실패시 표시
                        }
                    } catch (e) {
                        // 파싱 오류 시 기본적으로 표시
                        console.warn('시간 파싱 오류:', e, 'effectiveTime:', effectiveTime, 'expiryTime:', expiryTime);
                        isVisible = true;
                    }
                } else {
                    console.log(`NOTAM ${index + 1}: 시간 정보 부족 또는 UFN`, { effectiveTime, expiryTime });
                }

                // 개별 NOTAM 카드 표시/숨김
                if (isVisible) {
                    item.style.display = 'block';
                    item.querySelector('.notam-status').textContent = '활성';
                    item.querySelector('.notam-status').className = 'badge bg-success float-end notam-status';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
                
                // 통합 탭 섹션의 해당 NOTAM 항목들도 필터링
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = isVisible ? 'block' : 'none';
                });
            });

            document.getElementById('filterStatus').textContent = 
                `필터링 결과: ${visibleCount}개 NOTAM이 시간 범위에 포함됨 (전체: ${totalNotams}개)`;
            
            // 통합 탭 상태 업데이트
            document.getElementById('summaryFilterStatus').textContent = 
                `시간 필터링 활성: ${visibleCount}개 NOTAM만 표시 중`;
        }

        function showAllNotams() {
            const notamItems = document.querySelectorAll('.notam-item');
            notamItems.forEach((item, index) => {
                item.style.display = 'block';
                item.querySelector('.notam-status').textContent = '표시됨';
                item.querySelector('.notam-status').className = 'badge bg-info float-end notam-status';
                
                // 통합 탭 섹션의 모든 NOTAM 항목도 표시
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = 'block';
                });
            });

            document.getElementById('filterStatus').textContent = 
                `전체 NOTAM: ${totalNotams}개 (시간 필터링 비활성화 - 모든 NOTAM 표시)`;
            
            // 통합 탭 상태 업데이트
            document.getElementById('summaryFilterStatus').textContent = 
                `시간 필터링 비활성: 전체 ${totalNotams}개 NOTAM 표시 중`;
        }

        // 페이지 로드 시 NOTAM 데이터 확인
        document.addEventListener('DOMContentLoaded', function() {
            // 서버에서 전달된 공항 코드 사용
            const airportCodes = [
                {% for notam in notams %}
                    {% if notam.airport_code %}'{{ notam.airport_code }}',{% endif %}
                {% endfor %}
            ];
            
            // 중복 제거 및 정렬
            const uniqueAirports = [...new Set(airportCodes)].sort();
            console.log('추출된 공항 코드:', uniqueAirports);
            
            // 공항 필터 초기화 (패키지별 공항 필터가 없는 경우에만)
            const packageAirports = {{ package_airports|tojson|safe if package_airports else 'null' }};
            if (!packageAirports) {
                if (uniqueAirports.length > 0) {
                    renderAirportFilter(uniqueAirports);
                } else {
                    document.getElementById('airportFilter').innerHTML = 
                        '<div class="text-muted">사용 가능한 공항이 없습니다.</div>';
                }
            } else {
                // 패키지별 공항 필터가 있는 경우 이벤트 리스너만 설정
                setupAirportFilterListeners();
            }
            
            // 디버깅: 모든 NOTAM 아이템의 시간 데이터 출력
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('=== NOTAM 시간 데이터 디버깅 ===');
            notamItems.forEach((item, index) => {
                console.log(`NOTAM ${index + 1}:`, {
                    effectiveTime: item.dataset.effectiveTime,
                    expiryTime: item.dataset.expiryTime,
                    rawHTML: item.outerHTML.substring(0, 200) + '...'
                });
            });
            console.log('=== 디버깅 완료 ===');
            
            // 시간 필터링 스위치 상태에 따라 초기화
            const timeFilterSwitch = document.getElementById('timeFilterSwitch');
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (timeFilterSwitch.checked) {
                // 필터링이 켜져 있으면 카드 활성화
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                document.getElementById('filterStatus').textContent = 
                    `전체 NOTAM: ${totalNotams}개 (시간 필터 설정 후 '적용' 버튼을 클릭하세요)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `시간 범위를 설정하고 '적용' 버튼을 클릭하여 필터링하세요`;
                
                // 모든 NOTAM을 초기 상태로 표시
                const notamItems = document.querySelectorAll('.notam-item');
                notamItems.forEach((item, index) => {
                    item.style.display = 'block';
                    item.querySelector('.notam-status').textContent = '대기중';
                    item.querySelector('.notam-status').className = 'badge bg-warning float-end notam-status';
                    
                    // 통합 탭 섹션도 표시
                    const notamIndex = index + 1;
                    const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                    summaryItems.forEach(summaryItem => {
                        summaryItem.style.display = 'block';
                    });
                });
            } else {
                // 필터링이 꺼져 있으면 카드 비활성화 스타일
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // 모든 NOTAM 표시
                showAllNotams();
            }

            // 루트 분석 관련 이벤트 리스너 설정
            document.getElementById('analyzeRouteBtn').addEventListener('click', function() {
                analyzeRoute();
            });

            document.getElementById('clearRouteBtn').addEventListener('click', function() {
                clearRoute();
            });

            document.getElementById('routeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    analyzeRoute();
                }
            });
        });

        // 공항 필터 UI 렌더링
        function renderAirportFilter(airports) {
            const airportFilterContainer = document.getElementById('airportFilter');
            
            const checkboxes = airports.map(airport => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input airport-checkbox" type="checkbox" 
                           id="airport_${airport}" value="${airport}" checked>
                    <label class="form-check-label" for="airport_${airport}">
                        ${airport}
                    </label>
                </div>
            `).join('');

            airportFilterContainer.innerHTML = checkboxes;

            // 공항 필터 이벤트 리스너 추가
            setupAirportFilterListeners();
        }

        // 공항 필터 이벤트 리스너 설정
        function setupAirportFilterListeners() {
            // 전체 선택/해제 버튼
            document.getElementById('selectAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = true);
            });

            document.getElementById('clearAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = false);
            });

            // 필터 적용 버튼
            document.getElementById('applyAirportFilter').addEventListener('click', function() {
                applyAirportFilter();
            });
        }

        // 공항 필터 적용 함수
        function applyAirportFilter() {
            const selectedAirports = Array.from(document.querySelectorAll('.airport-checkbox:checked'))
                .map(checkbox => checkbox.value);

            console.log('선택된 공항:', selectedAirports);

            const notamItems = document.querySelectorAll('.notam-item');
            const notamSummaryItems = document.querySelectorAll('.notam-summary-item');
            let visibleCount = 0;

            // 개별 NOTAM 카드 필터링
            notamItems.forEach((item, index) => {
                // NOTAM에서 공항 코드 추출 (bg-info 배지 사용)
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const notamAirports = Array.from(airportBadges).map(badge => badge.textContent.trim());

                console.log(`NOTAM ${index + 1} 공항:`, notamAirports);

                // 선택된 공항과 일치하는지 확인
                const hasMatchingAirport = notamAirports.some(airport => selectedAirports.includes(airport));

                if (selectedAirports.length === 0 || hasMatchingAirport) {
                    item.style.display = 'block';
                    visibleCount++;
                    
                    // 상태 업데이트
                    const statusBadge = item.querySelector('.notam-status');
                    statusBadge.textContent = '표시됨';
                    statusBadge.className = 'badge bg-success float-end notam-status';
                } else {
                    item.style.display = 'none';
                    
                    // 상태 업데이트
                    const statusBadge = item.querySelector('.notam-status');
                    statusBadge.textContent = '필터됨';
                    statusBadge.className = 'badge bg-secondary float-end notam-status';
                }
            });

            // 전체 번역/요약 탭의 NOTAM 항목 필터링
            notamSummaryItems.forEach((item, index) => {
                const airportCode = item.getAttribute('data-airport-code');
                
                console.log(`Summary NOTAM ${index + 1} 공항:`, airportCode);

                if (selectedAirports.length === 0 || selectedAirports.includes(airportCode)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // 상태 업데이트
            const filterStatus = document.getElementById('filterStatus');
            if (selectedAirports.length === 0) {
                filterStatus.innerHTML = `전체 NOTAM: ${totalNotams}개 (공항 필터 없음 - 모든 NOTAM 표시)`;
            } else {
                filterStatus.innerHTML = `
                    필터링 결과: ${visibleCount}개 NOTAM이 선택된 공항에 포함됨 (전체: ${totalNotams}개)<br>
                    <strong>선택된 공항:</strong> ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')}
                `;
            }

            // 전체 번역/요약 탭 상태 업데이트
            const summaryFilterStatus = document.getElementById('summaryFilterStatus');
            if (selectedAirports.length === 0) {
                summaryFilterStatus.textContent = '모든 공항의 NOTAM이 표시됩니다.';
            } else {
                const visibleSummaryCount = document.querySelectorAll('.notam-summary-item[style*="display: block"], .notam-summary-item:not([style*="display: none"])').length;
                summaryFilterStatus.innerHTML = `
                    선택된 공항: ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')} - ${visibleSummaryCount}개 NOTAM 표시 중
                `;
            }

            console.log(`공항 필터 적용 완료: ${visibleCount}개 NOTAM 표시`);
        }

        // 구글지도 새 창 열기
        function openGoogleMaps() {
            window.open('/google_maps', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // 루트 분석 관련 함수들

        function analyzeRoute() {
            const routeInput = document.getElementById('routeInput').value.trim();
            
            if (!routeInput) {
                alert('항로를 입력해주세요.');
                return;
            }

            // 로딩 상태 표시
            const analyzeBtn = document.getElementById('analyzeRouteBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>AI 분석 중...';
            analyzeBtn.disabled = true;

            // AI 기반 루트 분석
            performAIRouteAnalysis(routeInput)
                .then(result => {
                    displayAIRouteAnalysis(result);
                })
                .catch(error => {
                    console.error('AI 분석 오류:', error);
                    // 폴백: 기존 분석 방식 사용
                    const analysisResult = performRouteAnalysis(routeInput);
                    displayRouteAnalysis(analysisResult);
                })
                .finally(() => {
                    // 버튼 상태 복원
                    analyzeBtn.innerHTML = originalText;
                    analyzeBtn.disabled = false;
                });
        }

        async function performAIRouteAnalysis(route) {
            try {
                // 현재 페이지의 NOTAM 데이터 수집
                const notamData = collectCurrentNotamData();
                
                const response = await fetch('/api/analyze_route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        route: route,
                        notam_data: notamData
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('AI 분석 API 호출 실패:', error);
                throw error;
            }
        }

        function collectCurrentNotamData() {
            const notamItems = document.querySelectorAll('.notam-item');
            const notamData = [];
            
            notamItems.forEach((item, index) => {
                const notamNumber = item.querySelector('td')?.textContent?.trim() || '';
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const airports = Array.from(airportBadges).map(badge => badge.textContent.trim());
                const notamText = item.querySelector('.notam-text')?.textContent?.trim() || '';
                const effectiveTime = item.querySelector('[data-effective-time]')?.dataset.effectiveTime || '';
                const expiryTime = item.querySelector('[data-expiry-time]')?.dataset.expiryTime || '';
                
                notamData.push({
                    index: index + 1,
                    notam_number: notamNumber,
                    airports: airports,
                    text: notamText,
                    effective_time: effectiveTime,
                    expiry_time: expiryTime
                });
            });
            
            return notamData;
        }

        function displayAIRouteAnalysis(result) {
            const resultDiv = document.getElementById('routeAnalysisResult');
            const contentDiv = document.getElementById('routeAnalysisContent');
            
            // AI 분석 결과를 마크다운 형식으로 표시
            const formattedAnalysis = formatMarkdownToHTML(result.analysis);
            
            contentDiv.innerHTML = `
                <div class="alert alert-success mb-3">
                    <h5 class="alert-heading">🤖 AI 기반 항로 분석 결과</h5>
                    <p class="mb-0"><strong>분석 항로:</strong> ${result.route}</p>
                    <small class="text-muted">분석 시간: ${new Date(result.timestamp).toLocaleString()}</small>
                </div>
                <div class="ai-analysis-content">
                    ${formattedAnalysis}
                </div>
            `;
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function formatMarkdownToHTML(markdown) {
            // 간단한 마크다운을 HTML로 변환
            return markdown
                .replace(/^## (.*$)/gim, '<h4 class="mt-4 mb-3">$1</h4>')
                .replace(/^### (.*$)/gim, '<h5 class="mt-3 mb-2">$1</h5>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(?!<[h|l])/gm, '<p>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '');
        }

        function performRouteAnalysis(route) {
            // 입력된 루트에서 주요 지점들 추출
            const routePoints = extractRoutePoints(route);
            
            // 현재 NOTAM 데이터에서 관련 NOTAM 찾기
            const relevantNotams = findRelevantNotams(routePoints);
            
            // 분석 결과 생성
            return {
                route: route,
                routePoints: routePoints,
                relevantNotams: relevantNotams,
                analysis: generateRouteAnalysis(relevantNotams)
            };
        }

        function extractRoutePoints(route) {
            // 루트에서 주요 지점들 추출 (공항 코드, 항로 지점 등)
            const points = [];
            
            // 공항 코드 패턴 (4글자 대문자)
            const airportPattern = /\b([A-Z]{4})\b/g;
            let match;
            while ((match = airportPattern.exec(route)) !== null) {
                points.push({
                    type: 'airport',
                    code: match[1],
                    position: match.index
                });
            }

            // 항로 지점 패턴 (3-5글자 대문자)
            const waypointPattern = /\b([A-Z]{3,5})\b/g;
            while ((match = waypointPattern.exec(route)) !== null) {
                // 공항 코드가 아닌 경우만 추가
                if (!points.some(p => p.code === match[1])) {
                    points.push({
                        type: 'waypoint',
                        code: match[1],
                        position: match.index
                    });
                }
            }

            return points;
        }

        function findRelevantNotams(routePoints) {
            const relevantNotams = [];
            const notamItems = document.querySelectorAll('.notam-item');
            
            notamItems.forEach((item, index) => {
                const notamText = item.querySelector('.notam-text').textContent;
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const notamAirports = Array.from(airportBadges).map(badge => badge.textContent.trim());
                
                // 루트 지점과 관련된 NOTAM 찾기
                let isRelevant = false;
                let relevanceReasons = [];

                // 공항 코드 매칭
                routePoints.forEach(point => {
                    if (point.type === 'airport' && notamAirports.includes(point.code)) {
                        isRelevant = true;
                        relevanceReasons.push(`공항 ${point.code} 관련`);
                    }
                });

                // 항로 지점 매칭
                routePoints.forEach(point => {
                    if (point.type === 'waypoint' && notamText.includes(point.code)) {
                        isRelevant = true;
                        relevanceReasons.push(`항로 지점 ${point.code} 관련`);
                    }
                });

                // 특정 키워드 매칭 (GPS, RAIM, FLOW CTL 등)
                const keywords = ['GPS', 'RAIM', 'FLOW CTL', 'RADAR', 'VOR', 'DME', 'NDB'];
                keywords.forEach(keyword => {
                    if (notamText.includes(keyword)) {
                        isRelevant = true;
                        relevanceReasons.push(`${keyword} 관련`);
                    }
                });

                if (isRelevant) {
                    relevantNotams.push({
                        index: index + 1,
                        notamNumber: item.querySelector('td').textContent,
                        airports: notamAirports,
                        text: notamText.substring(0, 200) + '...',
                        relevanceReasons: relevanceReasons
                    });
                }
            });

            return relevantNotams;
        }

        function generateRouteAnalysis(relevantNotams) {
            if (relevantNotams.length === 0) {
                return "입력된 항로와 직접적으로 관련된 NOTAM을 찾을 수 없습니다.";
            }

            // Package 3 공항들을 동적으로 가져오기
            const packageAirports = {{ package_airports|tojson|safe if package_airports else 'null' }};
            const package3Airports = packageAirports && packageAirports.package3 ? packageAirports.package3 : [];
            
            // Package 3 관련 NOTAM만 필터링
            const package3Notams = relevantNotams.filter(notam => {
                return notam.airports.some(airport => package3Airports.includes(airport));
            });

            let analysis = `<strong>Package 3 관련 NOTAM 상세 분석</strong><br><br>`;
            analysis += `<div class="alert alert-primary mb-3">
                <strong>📋 분석 대상 공항:</strong> ${package3Airports.join(', ')}<br>
                <strong>🛣️ 항로:</strong> ${document.getElementById('routeInput').value}
            </div>`;

            if (package3Notams.length === 0) {
                analysis += `<div class="alert alert-warning">
                    <strong>⚠️ 주의:</strong> Package 3 공항들과 직접적으로 관련된 NOTAM을 찾을 수 없습니다.
                </div>`;
                return analysis;
            }

            analysis += `제시된 항로를 기준으로 검토했을 때, 아래 NOTAM들이 해당됩니다.<br><br>`;

            // NOTAM별 상세 분석
            package3Notams.forEach((notam, index) => {
                const notamText = notam.text.toLowerCase();
                const notamNumber = notam.notamNumber;
                const airports = notam.airports.join(', ');
                
                analysis += `<div class="card mb-3">`;
                analysis += `<div class="card-header">`;
                analysis += `<h6 class="mb-0">NOTAM #${notam.index} (${notamNumber})</h6>`;
                analysis += `<small class="text-muted">관련 공항: ${airports}</small>`;
                analysis += `</div>`;
                analysis += `<div class="card-body">`;

                // NOTAM 내용에 따른 상세 분석
                if (notamText.includes('flow ctl') || notamText.includes('sadli')) {
                    analysis += `<div class="alert alert-info">
                        <strong>✅ 해당:</strong> 이 항로는 한국(RKSI)에서 출발하여 중국 영공을 통과합니다. 
                        NOTAM에 명시된 SADLI 지점은 항로에 직접 포함되지 않더라도, 
                        인천과 상하이 ACC 간의 주요 관제 이관 지점이므로 항로상에서 관제 이양 절차가 적용될 가능성이 매우 높습니다.
                    </div>`;
                } else if (notamText.includes('gps') || notamText.includes('raim')) {
                    analysis += `<div class="alert alert-warning">
                        <strong>✅ 해당:</strong> 이륙 공항이 RKSI(인천)이므로, 비행 초반에 인천 FIR 내에서 GPS 신호 불안정 현상을 겪을 수 있습니다. 
                        비행 중 GPS 신호에만 의존하지 않도록 주의해야 합니다.
                    </div>`;
                } else if (notamText.includes('bopta') || notamText.includes('ponik')) {
                    analysis += `<div class="alert alert-warning">
                        <strong>✅ 해당:</strong> 이 항로는 BOPTA 지점에서 시작됩니다. 
                        이 NOTAM은 BOPTA에서 PONIK까지의 조건부 항로(CDR2)에 대한 내용이므로, 
                        비행 계획에 따라 해당 항로를 사용한다면 명시된 시간 및 고도 제한을 반드시 준수해야 합니다.
                    </div>`;
                } else if (notamText.includes('eastbound') || notamText.includes('ikeka')) {
                    analysis += `<div class="alert alert-secondary">
                        <strong>❌ 해당 없음:</strong> 이 NOTAM은 상하이에서 인천으로 진입하는 동쪽행(Eastbound) 항공기에 대한 지침입니다. 
                        출발지 RKSI에서 목적지 VVDN으로 향하는 비행은 방향이 다르므로 이 NOTAM은 해당되지 않습니다.
                    </div>`;
                } else if (notamText.includes('frng') || notamText.includes('firing') || notamText.includes('prohibited')) {
                    analysis += `<div class="alert alert-danger">
                        <strong>✅ 해당:</strong> 목적지 VVDN(다낭)은 베트남에 위치해 있습니다. 
                        이 항로는 베트남 영공을 통과하게 되므로, 
                        <strong>훈련 구역의 좌표와 고도(3,200피트/4,500피트)</strong>를 반드시 확인하여 
                        항로가 훈련 구역과 겹치지 않도록 주의해야 합니다.
                    </div>`;
                } else if (notamText.includes('vor') || notamText.includes('dme') || notamText.includes('ndb')) {
                    analysis += `<div class="alert alert-info">
                        <strong>ℹ️ 정보:</strong> 항로상의 항행 보조 시설 관련 정보입니다. 
                        해당 시설의 사용 가능 여부를 확인하고 필요시 대체 절차를 준비하세요.
                    </div>`;
                } else if (notamText.includes('radar') || notamText.includes('ads-b')) {
                    analysis += `<div class="alert alert-info">
                        <strong>ℹ️ 정보:</strong> 관제 서비스 관련 정보입니다. 
                        해당 구역에서의 관제 절차와 요구사항을 확인하세요.
                    </div>`;
                } else {
                    analysis += `<div class="alert alert-light">
                        <strong>📋 일반 정보:</strong> 항로 계획 시 참고할 일반적인 정보입니다.
                    </div>`;
                }

                analysis += `<div class="mt-2">
                    <small class="text-muted">
                        <strong>NOTAM 내용:</strong> ${notam.text.substring(0, 150)}...
                    </small>
                </div>`;

                analysis += `</div></div>`;
            });

            // 최종 요약 테이블
            analysis += `<div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">📊 최종 요약</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>NOTAM 번호</th>
                                <th>주요 내용</th>
                                <th>ROUTE 관련 여부</th>
                            </tr>
                        </thead>
                        <tbody>`;

            package3Notams.forEach(notam => {
                const notamText = notam.text.toLowerCase();
                let relevance = '';
                let relevanceClass = '';

                if (notamText.includes('flow ctl') || notamText.includes('sadli')) {
                    relevance = '관제 이양 지점 확인 필요';
                    relevanceClass = 'table-info';
                } else if (notamText.includes('gps') || notamText.includes('raim')) {
                    relevance = 'RKSI 출발이므로 해당';
                    relevanceClass = 'table-warning';
                } else if (notamText.includes('bopta') || notamText.includes('ponik')) {
                    relevance = 'BOPTA 지점 포함';
                    relevanceClass = 'table-warning';
                } else if (notamText.includes('eastbound') || notamText.includes('ikeka')) {
                    relevance = '해당 없음 (방향이 다름)';
                    relevanceClass = 'table-secondary';
                } else if (notamText.includes('frng') || notamText.includes('firing')) {
                    relevance = '베트남 영공 통과';
                    relevanceClass = 'table-danger';
                } else {
                    relevance = '정보성 NOTAM';
                    relevanceClass = 'table-light';
                }

                analysis += `<tr class="${relevanceClass}">
                    <td>NOTAM #${notam.index} (${notam.notamNumber})</td>
                    <td>${notam.text.substring(0, 80)}...</td>
                    <td>${relevance}</td>
                </tr>`;
            });

            analysis += `</tbody></table>
                </div>
            </div>`;

            // 권장사항
            analysis += `<div class="alert alert-success mt-3">
                <h6 class="alert-heading">🎯 권장사항</h6>
                <ul class="mb-0">
                    <li>중요도가 높은 NOTAM들을 우선적으로 검토하세요.</li>
                    <li>항로상의 각 지점별로 해당 NOTAM의 영향을 평가하세요.</li>
                    <li>대체 항로나 절차가 필요한지 확인하세요.</li>
                    <li>특히 베트남 영공의 사격 훈련 구역을 반드시 회피하세요.</li>
                </ul>
            </div>`;

            return analysis;
        }

        function displayRouteAnalysis(result) {
            const resultDiv = document.getElementById('routeAnalysisResult');
            const contentDiv = document.getElementById('routeAnalysisContent');
            
            contentDiv.innerHTML = result.analysis;
            resultDiv.style.display = 'block';
            
            // 결과 섹션으로 스크롤
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearRoute() {
            document.getElementById('routeInput').value = '';
            document.getElementById('routeAnalysisResult').style.display = 'none';
        }
    </script>
</body>
</html>