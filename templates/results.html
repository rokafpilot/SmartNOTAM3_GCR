<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOTAM ì²˜ë¦¬ ê²°ê³¼ - Smart NOTAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .translation-text {
            white-space: normal;
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
            word-wrap: break-word;
            padding: 10px;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            padding: 1rem;
            background-color: #fff;
        }
        .card-header-tabs {
            margin-bottom: -1px;
        }
        .badge {
            margin-left: 10px;
        }
        .time-filter-controls {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>NOTAM ëª©ë¡</h1>
            <a href="{{ url_for('index') }}" class="btn btn-primary">
                ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
            </a>
        </div>
        
        <!-- ì‹œê°„ í•„í„° ì œì–´ -->
        <div class="time-filter-controls">
            <div class="row align-items-center mb-3">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">NOTAM í•„í„° ì„¤ì •</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="timeFilterSwitch">
                            <label class="form-check-label" for="timeFilterSwitch">
                                ì‹œê°„ í•„í„°ë§
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì‹œê°„ ì„¤ì • ì¹´ë“œ (í•­ìƒ í‘œì‹œ) -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">ì‹œê°„ í•„í„° (ë¡œì»¬ ì‹œê°„)</h6>
                    <div class="row g-3" id="timeFilterInputs">
                        <div class="col-md-3">
                            <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="startDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="endDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                            <input type="time" class="form-control" id="startTime" value="00:00">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                            <input type="time" class="form-control" id="endTime" value="23:59">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block w-100" id="applyFilterBtn">
                                <i class="fas fa-search"></i> ì ìš©
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetFilterBtn">
                                <i class="fas fa-undo"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ê³µí•­ í•„í„° ì„¹ì…˜ -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">ê³µí•­ í•„í„°</h6>
                <div class="row">
                    <div class="col-md-8">
                        <div id="airportFilter" class="d-flex flex-wrap gap-2">
                            <!-- ê³µí•­ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            <div class="text-muted">ê³µí•­ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllAirports">ì „ì²´ ì„ íƒ</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllAirports">ì „ì²´ í•´ì œ</button>
                            <button type="button" class="btn btn-primary btn-sm" id="applyAirportFilter">í•„í„° ì ìš©</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìš”ì•½ ì •ë³´ -->
        <div class="alert alert-info" id="filterStatus">
            ì „ì²´ NOTAM: {{ notams|length }}ê°œ (ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±í™” - ëª¨ë“  NOTAM í‘œì‹œ)
            {% if all_airports %}
            <br><strong>í¬í•¨ëœ ê³µí•­:</strong> 
            {% for airport in all_airports %}
                <span class="badge bg-secondary me-1">{{ airport }}</span>
            {% endfor %}
            {% endif %}
        </div>

        <!-- NOTAM ëª©ë¡ -->
        <div id="notamContainer">
            {% for notam in notams %}
            <div class="card mb-4 notam-item" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        NOTAM #{{ loop.index }}
                        <span class="badge bg-success float-end notam-status">í™œì„±</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table">
                                <tr>
                                    <th style="width: 150px;">NOTAM ë²ˆí˜¸</th>
                                    <td>{{ notam.id }}</td>
                                </tr>
                                {% if notam.airport_codes %}
                                <tr>
                                    <th>ê´€ë ¨ ê³µí•­</th>
                                    <td>
                                        {% for airport in notam.airport_codes %}
                                            <span class="badge bg-primary me-1">{{ airport }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>ìœ íš¨ì‹œê°„</th>
                                    <td>{{ notam.local_time_display|default(notam.effective_time|default('N/A') ~ ' ~ ' ~ notam.expiry_time|default('N/A')) }}</td>
                                </tr>
                                <tr>
                                    <th>ì›ë¬¸</th>
                                    <td>{{ notam.description|default(notam.original_text|default(notam.raw_text)) }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì˜ì–´ ë²ˆì—­ -->
                    <div class="mt-3">
                        <h6 class="text-primary mb-2">ğŸ”¤ ì˜ì–´ ë²ˆì—­</h6>
                        <div class="translation-text bg-light p-3 rounded">
                            {{ notam.english_translation|default('Translation in progress...') }}
                        </div>
                    </div>
                    
                    <!-- í•œêµ­ì–´ ë²ˆì—­ -->
                    <div class="mt-3">
                        <h6 class="text-success mb-2">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ë²ˆì—­</h6>
                        <div class="translation-text bg-light p-3 rounded korean-translation">
                            {{ notam.korean_translation|default('ë²ˆì—­ ì¤€ë¹„ ì¤‘...') }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- í†µí•© ë²ˆì—­/ìš”ì•½ íƒ­ (í™”ë©´ ìµœí•˜ë‹¨) -->
        <div class="mt-5 mb-5">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">ğŸ“‹ ì „ì²´ NOTAM ë²ˆì—­ ë° ìš”ì•½</h4>
                    <small class="text-muted" id="summaryFilterStatus">
                        ì‹œê°„ í•„í„°ë§ì´ ì ìš©ë˜ë©´ í•´ë‹¹ NOTAMë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                    </small>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="summaryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-korean-tab" data-bs-toggle="tab" data-bs-target="#all-korean" type="button" role="tab">
                                ğŸ‡°ğŸ‡· ì „ì²´ í•œêµ­ì–´ ë²ˆì—­
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-tab" data-bs-toggle="tab" data-bs-target="#all-english" type="button" role="tab">
                                ğŸ”¤ ì „ì²´ ì˜ì–´ ë²ˆì—­
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-korean-summary-tab" data-bs-toggle="tab" data-bs-target="#all-korean-summary" type="button" role="tab">
                                ğŸ“„ ì „ì²´ í•œêµ­ì–´ ìš”ì•½
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-summary-tab" data-bs-toggle="tab" data-bs-target="#all-english-summary" type="button" role="tab">
                                ğŸ“„ ì „ì²´ ì˜ì–´ ìš”ì•½
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="summaryTabContent">
                        <!-- ì „ì²´ í•œêµ­ì–´ ë²ˆì—­ -->
                        <div class="tab-pane fade show active" id="all-korean" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-primary">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_translation|default('ë²ˆì—­ ì¤€ë¹„ ì¤‘...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ ì˜ì–´ ë²ˆì—­ -->
                        <div class="tab-pane fade" id="all-english" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-info">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_translation|default('Translation in progress...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ í•œêµ­ì–´ ìš”ì•½ -->
                        <div class="tab-pane fade" id="all-korean-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-success">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_summary|default('ìš”ì•½ ì¤€ë¹„ ì¤‘...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ ì˜ì–´ ìš”ì•½ -->
                        <div class="tab-pane fade" id="all-english-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-warning">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_summary|default('Summary in progress...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">
                Smart NOTAM &copy; 2025. í•­ê³µ ì •ë³´ ë²ˆì—­ ì‹œìŠ¤í…œ
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let totalNotams = {{ notams|length }};
        
        // ì‹œê°„ í•„í„° í† ê¸€
        document.getElementById('timeFilterSwitch').addEventListener('change', function() {
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (this.checked) {
                // í•„í„°ë§ í™œì„±í™” - ì¹´ë“œ í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                document.getElementById('filterStatus').textContent = 
                    `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ì‹œê°„ í•„í„° ì„¤ì • í›„ 'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ê³  'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í•„í„°ë§í•˜ì„¸ìš”`;
            } else {
                // í•„í„°ë§ ë¹„í™œì„±í™” - ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // ëª¨ë“  NOTAM í‘œì‹œ
                showAllNotams();
            }
        });

        // ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('resetFilterBtn').addEventListener('click', function() {
            // ì‹œê°„ ì…ë ¥ê°’ ì´ˆê¸°í™”
            document.getElementById('startDate').value = '{{ current_date }}';
            document.getElementById('endDate').value = '{{ current_date }}';
            document.getElementById('startTime').value = '06:00';
            document.getElementById('endTime').value = '08:00';
            
            // í•„í„°ë§ì´ ì¼œì ¸ ìˆìœ¼ë©´ ì ìš©
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // Enter í‚¤ë¡œë„ í•„í„° ì ìš© ê°€ëŠ¥
        ['startDate', 'endDate', 'startTime', 'endTime'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('applyFilterBtn').click();
                }
            });
        });

        function applyTimeFilter() {
            if (!document.getElementById('timeFilterSwitch').checked) {
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            console.log('í•„í„° ì…ë ¥ê°’:', { startDate, endDate, startTime, endTime });

            if (!startDate || !endDate || !startTime || !endTime) {
                alert('ëª¨ë“  ì‹œê°„ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const filterStart = new Date(startDate + 'T' + startTime);
            const filterEnd = new Date(endDate + 'T' + endTime);
            
            console.log('í•„í„° ë²”ìœ„:', filterStart, '~', filterEnd);

            let visibleCount = 0;
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('ì´ NOTAM ìˆ˜:', notamItems.length);

            notamItems.forEach((item, index) => {
                const effectiveTime = item.dataset.effectiveTime;
                const expiryTime = item.dataset.expiryTime;
                
                console.log(`NOTAM ${index + 1} ì›ë³¸ ì‹œê°„:`, { 
                    effectiveTime, 
                    expiryTime,
                    hasEffective: !!effectiveTime,
                    hasExpiry: !!expiryTime,
                    isUFN: expiryTime === 'UFN'
                });
                
                let isVisible = true;
                
                // ì‹¤ì œ ì‹œê°„ í•„í„°ë§ ë¡œì§
                if (effectiveTime && expiryTime && effectiveTime !== 'UFN' && expiryTime !== 'UFN') {
                    try {
                        // NOTAM ì‹œê°„ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
                        let notamStart, notamEnd;
                        
                        console.log(`NOTAM ${index + 1} ì›ë³¸ ë°ì´í„°:`, { effectiveTime, expiryTime });
                        
                        // UTC ì‹œê°„ì„ ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                        if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamStart = new Date(effectiveTime);
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            // UTC ì—†ëŠ” ISO í˜•ì‹ì€ UTCë¡œ ì²˜ë¦¬
                            notamStart = new Date(effectiveTime + 'Z');
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            // 2025-07-09 16:00 í˜•ì‹ì„ UTCë¡œ ì²˜ë¦¬
                            notamStart = new Date(effectiveTime.replace(' ', 'T') + ':00Z');
                        } else {
                            // ê¸°íƒ€ í˜•ì‹
                            notamStart = new Date(effectiveTime);
                        }
                        
                        if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamEnd = new Date(expiryTime);
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime + 'Z');
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime.replace(' ', 'T') + ':00Z');
                        } else {
                            notamEnd = new Date(expiryTime);
                        }
                        
                        if (!isNaN(notamStart.getTime()) && !isNaN(notamEnd.getTime())) {
                            // SmartNOTAMgemini_GCR ë°©ì‹: ê²¹ì¹¨ í™•ì¸
                            // ê²¹ì¹˜ëŠ” ì¡°ê±´: notamStart <= filterEnd && notamEnd >= filterStart
                            const isOverlapping = notamStart <= filterEnd && notamEnd >= filterStart;
                            isVisible = isOverlapping;
                            
                            console.log(`NOTAM ${index + 1} ì‹œê°„ ë¶„ì„ (ë¡œì»¬):`, {
                                notamStart: notamStart.toLocaleString(),
                                notamEnd: notamEnd.toLocaleString(),
                                filterStart: filterStart.toLocaleString(),
                                filterEnd: filterEnd.toLocaleString(),
                                isOverlapping: isOverlapping,
                                visible: isVisible
                            });
                        } else {
                            console.warn(`NOTAM ${index + 1} ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨:`, {
                                effectiveTime,
                                expiryTime,
                                notamStart: isNaN(notamStart.getTime()) ? 'Invalid' : notamStart.toISOString(),
                                notamEnd: isNaN(notamEnd.getTime()) ? 'Invalid' : notamEnd.toISOString()
                            });
                            isVisible = true;  // íŒŒì‹± ì‹¤íŒ¨ì‹œ í‘œì‹œ
                        }
                    } catch (e) {
                        // íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ
                        console.warn('ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜:', e, 'effectiveTime:', effectiveTime, 'expiryTime:', expiryTime);
                        isVisible = true;
                    }
                } else {
                    console.log(`NOTAM ${index + 1}: ì‹œê°„ ì •ë³´ ë¶€ì¡± ë˜ëŠ” UFN`, { effectiveTime, expiryTime });
                }

                // ê°œë³„ NOTAM ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€
                if (isVisible) {
                    item.style.display = 'block';
                    item.querySelector('.notam-status').textContent = 'í™œì„±';
                    item.querySelector('.notam-status').className = 'badge bg-success float-end notam-status';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
                
                // í†µí•© íƒ­ ì„¹ì…˜ì˜ í•´ë‹¹ NOTAM í•­ëª©ë“¤ë„ í•„í„°ë§
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = isVisible ? 'block' : 'none';
                });
            });

            document.getElementById('filterStatus').textContent = 
                `í•„í„°ë§ ê²°ê³¼: ${visibleCount}ê°œ NOTAMì´ ì‹œê°„ ë²”ìœ„ì— í¬í•¨ë¨ (ì „ì²´: ${totalNotams}ê°œ)`;
            
            // í†µí•© íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('summaryFilterStatus').textContent = 
                `ì‹œê°„ í•„í„°ë§ í™œì„±: ${visibleCount}ê°œ NOTAMë§Œ í‘œì‹œ ì¤‘`;
        }

        function showAllNotams() {
            const notamItems = document.querySelectorAll('.notam-item');
            notamItems.forEach((item, index) => {
                item.style.display = 'block';
                item.querySelector('.notam-status').textContent = 'í‘œì‹œë¨';
                item.querySelector('.notam-status').className = 'badge bg-info float-end notam-status';
                
                // í†µí•© íƒ­ ì„¹ì…˜ì˜ ëª¨ë“  NOTAM í•­ëª©ë„ í‘œì‹œ
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = 'block';
                });
            });

            document.getElementById('filterStatus').textContent = 
                `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±í™” - ëª¨ë“  NOTAM í‘œì‹œ)`;
            
            // í†µí•© íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('summaryFilterStatus').textContent = 
                `ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±: ì „ì²´ ${totalNotams}ê°œ NOTAM í‘œì‹œ ì¤‘`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ NOTAM ë°ì´í„° í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê³µí•­ ì½”ë“œ ì‚¬ìš©
            const airportCodes = [
                {% for notam in notams %}
                    {% if notam.airport_code %}'{{ notam.airport_code }}',{% endif %}
                {% endfor %}
            ];
            
            // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
            const uniqueAirports = [...new Set(airportCodes)].sort();
            console.log('ì¶”ì¶œëœ ê³µí•­ ì½”ë“œ:', uniqueAirports);
            
            // ê³µí•­ í•„í„° ì´ˆê¸°í™”
            if (uniqueAirports.length > 0) {
                renderAirportFilter(uniqueAirports);
            } else {
                document.getElementById('airportFilter').innerHTML = 
                    '<div class="text-muted">ì‚¬ìš© ê°€ëŠ¥í•œ ê³µí•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            // ë””ë²„ê¹…: ëª¨ë“  NOTAM ì•„ì´í…œì˜ ì‹œê°„ ë°ì´í„° ì¶œë ¥
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('=== NOTAM ì‹œê°„ ë°ì´í„° ë””ë²„ê¹… ===');
            notamItems.forEach((item, index) => {
                console.log(`NOTAM ${index + 1}:`, {
                    effectiveTime: item.dataset.effectiveTime,
                    expiryTime: item.dataset.expiryTime,
                    rawHTML: item.outerHTML.substring(0, 200) + '...'
                });
            });
            console.log('=== ë””ë²„ê¹… ì™„ë£Œ ===');
            
            // ì‹œê°„ í•„í„°ë§ ìŠ¤ìœ„ì¹˜ ìƒíƒœì— ë”°ë¼ ì´ˆê¸°í™”
            const timeFilterSwitch = document.getElementById('timeFilterSwitch');
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (timeFilterSwitch.checked) {
                // í•„í„°ë§ì´ ì¼œì ¸ ìˆìœ¼ë©´ ì¹´ë“œ í™œì„±í™”
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                document.getElementById('filterStatus').textContent = 
                    `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ì‹œê°„ í•„í„° ì„¤ì • í›„ 'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ê³  'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í•„í„°ë§í•˜ì„¸ìš”`;
                
                // ëª¨ë“  NOTAMì„ ì´ˆê¸° ìƒíƒœë¡œ í‘œì‹œ
                const notamItems = document.querySelectorAll('.notam-item');
                notamItems.forEach((item, index) => {
                    item.style.display = 'block';
                    item.querySelector('.notam-status').textContent = 'ëŒ€ê¸°ì¤‘';
                    item.querySelector('.notam-status').className = 'badge bg-warning float-end notam-status';
                    
                    // í†µí•© íƒ­ ì„¹ì…˜ë„ í‘œì‹œ
                    const notamIndex = index + 1;
                    const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                    summaryItems.forEach(summaryItem => {
                        summaryItem.style.display = 'block';
                    });
                });
            } else {
                // í•„í„°ë§ì´ êº¼ì ¸ ìˆìœ¼ë©´ ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // ëª¨ë“  NOTAM í‘œì‹œ
                showAllNotams();
            }
        });

        // ê³µí•­ í•„í„° UI ë Œë”ë§
        function renderAirportFilter(airports) {
            const airportFilterContainer = document.getElementById('airportFilter');
            
            const checkboxes = airports.map(airport => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input airport-checkbox" type="checkbox" 
                           id="airport_${airport}" value="${airport}" checked>
                    <label class="form-check-label" for="airport_${airport}">
                        ${airport}
                    </label>
                </div>
            `).join('');

            airportFilterContainer.innerHTML = checkboxes;

            // ê³µí•­ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupAirportFilterListeners();
        }

        // ê³µí•­ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupAirportFilterListeners() {
            // ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
            document.getElementById('selectAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = true);
            });

            document.getElementById('clearAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = false);
            });

            // í•„í„° ì ìš© ë²„íŠ¼
            document.getElementById('applyAirportFilter').addEventListener('click', function() {
                applyAirportFilter();
            });
        }

        // ê³µí•­ í•„í„° ì ìš© í•¨ìˆ˜
        function applyAirportFilter() {
            const selectedAirports = Array.from(document.querySelectorAll('.airport-checkbox:checked'))
                .map(checkbox => checkbox.value);

            console.log('ì„ íƒëœ ê³µí•­:', selectedAirports);

            const notamItems = document.querySelectorAll('.notam-item');
            const notamSummaryItems = document.querySelectorAll('.notam-summary-item');
            let visibleCount = 0;

            // ê°œë³„ NOTAM ì¹´ë“œ í•„í„°ë§
            notamItems.forEach((item, index) => {
                // NOTAMì—ì„œ ê³µí•­ ì½”ë“œ ì¶”ì¶œ
                const airportBadges = item.querySelectorAll('.badge.bg-primary');
                const notamAirports = Array.from(airportBadges).map(badge => badge.textContent.trim());

                console.log(`NOTAM ${index + 1} ê³µí•­:`, notamAirports);

                // ì„ íƒëœ ê³µí•­ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                const hasMatchingAirport = notamAirports.some(airport => selectedAirports.includes(airport));

                if (selectedAirports.length === 0 || hasMatchingAirport) {
                    item.style.display = 'block';
                    visibleCount++;
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    const statusBadge = item.querySelector('.notam-status');
                    statusBadge.textContent = 'í‘œì‹œë¨';
                    statusBadge.className = 'badge bg-success float-end notam-status';
                } else {
                    item.style.display = 'none';
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    const statusBadge = item.querySelector('.notam-status');
                    statusBadge.textContent = 'í•„í„°ë¨';
                    statusBadge.className = 'badge bg-secondary float-end notam-status';
                }
            });

            // ì „ì²´ ë²ˆì—­/ìš”ì•½ íƒ­ì˜ NOTAM í•­ëª© í•„í„°ë§
            notamSummaryItems.forEach((item, index) => {
                const airportCode = item.getAttribute('data-airport-code');
                
                console.log(`Summary NOTAM ${index + 1} ê³µí•­:`, airportCode);

                if (selectedAirports.length === 0 || selectedAirports.includes(airportCode)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            const filterStatus = document.getElementById('filterStatus');
            if (selectedAirports.length === 0) {
                filterStatus.innerHTML = `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ê³µí•­ í•„í„° ì—†ìŒ - ëª¨ë“  NOTAM í‘œì‹œ)`;
            } else {
                filterStatus.innerHTML = `
                    í•„í„°ë§ ê²°ê³¼: ${visibleCount}ê°œ NOTAMì´ ì„ íƒëœ ê³µí•­ì— í¬í•¨ë¨ (ì „ì²´: ${totalNotams}ê°œ)<br>
                    <strong>ì„ íƒëœ ê³µí•­:</strong> ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')}
                `;
            }

            // ì „ì²´ ë²ˆì—­/ìš”ì•½ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            const summaryFilterStatus = document.getElementById('summaryFilterStatus');
            if (selectedAirports.length === 0) {
                summaryFilterStatus.textContent = 'ëª¨ë“  ê³µí•­ì˜ NOTAMì´ í‘œì‹œë©ë‹ˆë‹¤.';
            } else {
                const visibleSummaryCount = document.querySelectorAll('.notam-summary-item[style*="display: block"], .notam-summary-item:not([style*="display: none"])').length;
                summaryFilterStatus.innerHTML = `
                    ì„ íƒëœ ê³µí•­: ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')} - ${visibleSummaryCount}ê°œ NOTAM í‘œì‹œ ì¤‘
                `;
            }

            console.log(`ê³µí•­ í•„í„° ì ìš© ì™„ë£Œ: ${visibleCount}ê°œ NOTAM í‘œì‹œ`);
        }
    </script>
</body>
</html>