<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOTAM ì²˜ë¦¬ ê²°ê³¼ - Smart NOTAM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            padding-top: 2rem;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .translation-text {
            white-space: normal;
            font-size: 0.95rem;
            line-height: 1.6;
            text-align: left;
            word-wrap: break-word;
            padding: 10px;
        }
        .nav-tabs .nav-link {
            color: #495057;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #495057;
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .tab-content {
            border: 1px solid #dee2e6;
            border-top: 0;
            padding: 1rem;
            background-color: #fff;
        }
        .card-header-tabs {
            margin-bottom: -1px;
        }
        .badge {
            margin-left: 10px;
        }
        .time-filter-controls {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .ai-analysis-content {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }
        .ai-analysis-content h4 {
            color: #28a745;
            border-bottom: 2px solid #28a745;
            padding-bottom: 8px;
        }
        .ai-analysis-content h5 {
            color: #495057;
            margin-top: 20px;
        }
        .ai-analysis-content ul {
            padding-left: 20px;
        }
        .ai-analysis-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .ai-analysis-content p {
            margin-bottom: 12px;
            line-height: 1.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>NOTAM ëª©ë¡</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                </a>
                <button type="button" class="btn btn-success" onclick="openGoogleMaps()">
                    <i class="fas fa-map-marked-alt me-2"></i>
                    êµ¬ê¸€ì§€ë„
                </button>
                <button type="button" class="btn btn-info" onclick="saveAsHTML()">
                    <i class="fas fa-download me-2"></i>
                    HTML ì €ì¥
                </button>
            </div>
        </div>
        
        <!-- ì‹œê°„ í•„í„° ì œì–´ -->
        <div class="time-filter-controls">
            <div class="row align-items-center mb-3">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">NOTAM í•„í„° ì„¤ì •</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="timeFilterSwitch">
                            <label class="form-check-label" for="timeFilterSwitch">
                                ì‹œê°„ í•„í„°ë§
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì‹œê°„ ì„¤ì • ì¹´ë“œ (í•­ìƒ í‘œì‹œ) -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">ì‹œê°„ í•„í„° (ë¡œì»¬ ì‹œê°„)</h6>
                    <div class="row g-3" id="timeFilterInputs">
                        <div class="col-md-3">
                            <label class="form-label">ì‹œì‘ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="startDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì¢…ë£Œ ë‚ ì§œ</label>
                            <input type="date" class="form-control" id="endDate" value="{{ current_date }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì‹œì‘ ì‹œê°„</label>
                            <input type="time" class="form-control" id="startTime" value="00:00">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">ì¢…ë£Œ ì‹œê°„</label>
                            <input type="time" class="form-control" id="endTime" value="23:59">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary d-block w-100" id="applyFilterBtn">
                                <i class="fas fa-search"></i> ì ìš©
                            </button>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="resetFilterBtn">
                                <i class="fas fa-undo"></i> ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ê³µí•­ í•„í„° ì„¹ì…˜ -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">ê³µí•­ í•„í„°</h6>
                
                <!-- íŒ¨í‚¤ì§€ë³„ ê³µí•­ í•„í„° -->
                {% if package_airports %}
                <div class="row">
                    {% for package_name, airports in package_airports.items() %}
                    {% if airports %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    {% if package_name == 'package1' %}
                                        Package 1
                                    {% elif package_name == 'package2' %}
                                        Package 2
                                    {% elif package_name == 'package3' %}
                                        Package 3
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-1">
                                    {% for airport in airports %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input airport-checkbox" type="checkbox" 
                                               value="{{ airport }}" id="{{ airport }}_{{ package_name }}">
                                        <label class="form-check-label" for="{{ airport }}_{{ package_name }}">
                                            {{ airport }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% else %}
                <!-- ê¸°ì¡´ ê³µí•­ í•„í„° (íŒ¨í‚¤ì§€ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°) -->
                <div class="row">
                    <div class="col-md-8">
                        <div id="airportFilter" class="d-flex flex-wrap gap-2">
                            <!-- ê³µí•­ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            <div class="text-muted">ê³µí•­ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllAirports">ì „ì²´ ì„ íƒ</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllAirports">ì „ì²´ í•´ì œ</button>
                            <button type="button" class="btn btn-primary btn-sm" id="applyAirportFilter">í•„í„° ì ìš©</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê³µí•­ í•„í„°ë§ ê²°ê³¼ -->
        <div class="alert alert-info" id="filterStatus" style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                ğŸ“Š í•„í„°ë§ ìƒíƒœ
            </div>
            <div id="filterStatusContent">
                ì „ì²´ NOTAM: {{ notams|length }}ê°œ (ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±í™” - ëª¨ë“  NOTAM í‘œì‹œ)
                {% if all_airports %}
                <br><strong>í¬í•¨ëœ ê³µí•­:</strong> 
                {% for airport in all_airports %}
                    <span class="badge bg-secondary me-1">{{ airport }}</span>
                {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- ë£¨íŠ¸ ì…ë ¥ ì¹´ë“œ -->
        <div class="card mb-3">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-route me-2"></i>ë£¨íŠ¸ ì…ë ¥
                </h6>
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="routeInput" class="form-label">í•­ë¡œ ì…ë ¥</label>
                            <textarea class="form-control" id="routeInput" rows="3" 
                                placeholder="ì˜ˆ: ROUTE 1: BOPTA Z51 BEDES Y711 MUGUS Y742 SALMI Q11 TACLE B591 HCN G86 KAPLI MADRU SULUX IGLEG IKELA A1 BUNT2M.RW35B"></textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column justify-content-end h-100">
                            <button type="button" class="btn btn-primary mb-2" id="analyzeRouteBtn">
                                <i class="fas fa-robot me-2"></i>AI í•­ë¡œ ë¶„ì„
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearRouteBtn">
                                <i class="fas fa-eraser me-1"></i>ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="routeAnalysisResult" style="display: none;">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>ë£¨íŠ¸ ë¶„ì„ ê²°ê³¼
                            </h6>
                            <div id="routeAnalysisContent">
                                <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ê³µí•­ë³„ NOTAM ë¶„ì„ ì„¹ì…˜ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-plane-departure me-2"></i>
                            ê³µí•­ë³„ ì£¼ìš” NOTAM ë¶„ì„
                        </h4>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            NOTAMì—ì„œ ìë™ìœ¼ë¡œ ì¶”ì¶œëœ ê³µí•­ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì£¼ìš” NOTAM ì‚¬í•­ì„ ì •ë¦¬ ë¶„ì„í•©ë‹ˆë‹¤.
                        </p>
                        
                        <!-- ì¶”ì¶œëœ ê³µí•­ ì •ë³´ í‘œì‹œ -->
                        <div id="extractedAirportInfo" class="mb-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="alert-heading">ğŸ“‹ ì¶”ì¶œëœ ê³µí•­ ì •ë³´</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td><strong>DEP (ì¶œë°œ):</strong></td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="editDep" placeholder="RKSI" maxlength="4">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>DEST (ëª©ì ì§€):</strong></td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="editDest" placeholder="KSEA" maxlength="4">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>ALTN (ëŒ€ì²´):</strong></td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="editAltn" placeholder="KPDX" maxlength="20">
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td><strong>REFILE:</strong></td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="editRefile" placeholder="PANC PAED" maxlength="20">
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>EDTO:</strong></td>
                                                <td>
                                                    <input type="text" class="form-control form-control-sm" id="editEdto" placeholder="RJCC PANC CYVR" maxlength="30">
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        ğŸ’¡ ì¶”ì¶œëœ ì •ë³´ê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ì • í›„ ë¶„ì„ì„ ì§„í–‰í•˜ì„¸ìš”.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ë¶„ì„ ë²„íŠ¼ë“¤ -->
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" id="startAirportAnalysisBtn">
                                <i class="fas fa-search me-2"></i>
                                ê³µí•­ë³„ NOTAM ë¶„ì„ ì‹œì‘
                            </button>
                            <button type="button" class="btn btn-info btn-lg" id="comprehensiveAnalysisBtn">
                                <i class="fas fa-brain me-2"></i>
                                AI ì¢…í•© ë¶„ì„ (GEMINI)
                            </button>
                        </div>
                        
                        <!-- ë¶„ì„ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                        <div id="airportAnalysisResult" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-chart-bar me-2"></i>
                                        ë¶„ì„ ê²°ê³¼
                                    </h5>
                                </div>
                                <div class="card-body" id="airportAnalysisContent">
                                    <!-- ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOTAM ëª©ë¡ -->
        <div id="notamContainer">
            {% for notam in notams %}
            <div class="card mb-4 notam-item" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        NOTAM #{{ loop.index }}
                        {% if notam.airport_codes %}
                            {% for airport in notam.airport_codes %}
                                <span class="badge bg-info ms-2">{{ airport }}</span>
                            {% endfor %}
                        {% elif notam.airport_code %}
                            <span class="badge bg-info ms-2">{{ notam.airport_code }}</span>
                        {% endif %}
                        <span class="badge float-end notam-status" 
                              data-category="{{ notam.category or 'OTHER' }}"
                              data-category-icon="{{ notam.category_icon or 'ğŸ“„' }}"
                              data-category-color="{{ notam.category_color or '#6c757d' }}"
                              data-category-bg-color="{{ notam.category_bg_color or '#e9ecef' }}"
                              style="background-color: {{ notam.category_bg_color or '#e9ecef' }}; color: {{ notam.category_color or '#6c757d' }}; border: 1px solid {{ notam.category_color or '#6c757d' }};">
                            {{ notam.category_icon or 'ğŸ“„' }} {{ notam.category or 'OTHER' }}
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table">
                                <tr>
                                    <th style="width: 150px;">NOTAM ë²ˆí˜¸</th>
                                    <td>{{ notam.notam_number }}</td>
                                </tr>
                                {% if notam.airport_codes %}
                                <tr>
                                    <th>ê´€ë ¨ ê³µí•­</th>
                                    <td>
                                        {% for airport in notam.airport_codes %}
                                            <span class="badge bg-primary me-1">{{ airport }}</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>ìœ íš¨ì‹œê°„</th>
                                    <td>
                                        {{ notam.local_time_display|default(notam.effective_time|default('N/A') ~ ' ~ ' ~ notam.expiry_time|default('N/A')) }}
                                        {% if not notam.local_time_display %}
                                        <br><small style="color: red;">DEBUG: local_time_display ì—†ìŒ | effective_time: {{ notam.effective_time|default('None') }} | expiry_time: {{ notam.expiry_time|default('None') }}</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>ì›ë¬¸</th>
                                    <td class="preserve-linebreaks notam-text">{{ notam.original_text|default(notam.description|default(notam.raw_text))|safe }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ì˜ì–´ ë²ˆì—­ -->
                    <div class="mt-3">
                        <h6 class="text-primary mb-2">ğŸ”¤ ì˜ì–´ ë²ˆì—­</h6>
                        <div class="translation-text bg-light p-3 rounded preserve-linebreaks notam-text">
                            {{ notam.english_translation|default('Translation in progress...')|safe }}
                        </div>
                    </div>
                    
                    <!-- í•œêµ­ì–´ ë²ˆì—­ -->
                    <div class="mt-3">
                        <h6 class="text-success mb-2">ğŸ‡°ğŸ‡· í•œêµ­ì–´ ë²ˆì—­</h6>
                        <div class="translation-text bg-light p-3 rounded korean-translation notam-text">
                            {{ notam.korean_translation|default('ë²ˆì—­ ì¤€ë¹„ ì¤‘...')|safe }}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- í†µí•© ë²ˆì—­/ìš”ì•½ íƒ­ (í™”ë©´ ìµœí•˜ë‹¨) -->
        <div class="mt-5 mb-5">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">ğŸ“‹ ì „ì²´ NOTAM ë²ˆì—­ ë° ìš”ì•½</h4>
                    <small class="text-muted" id="summaryFilterStatus">
                        ì‹œê°„ í•„í„°ë§ì´ ì ìš©ë˜ë©´ í•´ë‹¹ NOTAMë§Œ í‘œì‹œë©ë‹ˆë‹¤.
                    </small>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="summaryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-korean-tab" data-bs-toggle="tab" data-bs-target="#all-korean" type="button" role="tab">
                                ğŸ‡°ğŸ‡· ì „ì²´ í•œêµ­ì–´ ë²ˆì—­
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-tab" data-bs-toggle="tab" data-bs-target="#all-english" type="button" role="tab">
                                ğŸ”¤ ì „ì²´ ì˜ì–´ ë²ˆì—­
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-korean-summary-tab" data-bs-toggle="tab" data-bs-target="#all-korean-summary" type="button" role="tab">
                                ğŸ“„ ì „ì²´ í•œêµ­ì–´ ìš”ì•½
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-english-summary-tab" data-bs-toggle="tab" data-bs-target="#all-english-summary" type="button" role="tab">
                                ğŸ“„ ì „ì²´ ì˜ì–´ ìš”ì•½
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="summaryTabContent">
                        <!-- ì „ì²´ í•œêµ­ì–´ ë²ˆì—­ -->
                        <div class="tab-pane fade show active" id="all-korean" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-primary">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_translation|default('ë²ˆì—­ ì¤€ë¹„ ì¤‘...')|safe }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ ì˜ì–´ ë²ˆì—­ -->
                        <div class="tab-pane fade" id="all-english" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-info">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_translation|default('Translation in progress...')|safe }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ í•œêµ­ì–´ ìš”ì•½ -->
                        <div class="tab-pane fade" id="all-korean-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-success">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded korean-translation">
                                        {{ notam.korean_summary|default('ìš”ì•½ ì¤€ë¹„ ì¤‘...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- ì „ì²´ ì˜ì–´ ìš”ì•½ -->
                        <div class="tab-pane fade" id="all-english-summary" role="tabpanel">
                            <div class="summary-content">
                                {% for notam in notams %}
                                <div class="notam-summary-item mb-4" data-notam-index="{{ loop.index }}" data-effective-time="{{ notam.effective_time }}" data-expiry-time="{{ notam.expiry_time }}" data-airport-code="{{ notam.airport_code }}">
                                    <h6 class="text-warning">
                                        NOTAM #{{ loop.index }} ({{ notam.id }})
                                        <span class="badge bg-primary ms-2">{{ notam.airport_code }}</span>
                                    </h6>
                                    <div class="translation-text bg-light p-3 rounded">
                                        {{ notam.english_summary|default('Summary in progress...') }}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">
                SmartNOTAM &copy; 2025. SH Smart NOTAM System
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let totalNotams = {{ notams|length }};
        
        // ì‹œê°„ í•„í„° í† ê¸€
        document.getElementById('timeFilterSwitch').addEventListener('change', function() {
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (this.checked) {
                // í•„í„°ë§ í™œì„±í™” - ì¹´ë“œ í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                document.getElementById('filterStatus').textContent = 
                    `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ì‹œê°„ í•„í„° ì„¤ì • í›„ 'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ê³  'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í•„í„°ë§í•˜ì„¸ìš”`;
            } else {
                // í•„í„°ë§ ë¹„í™œì„±í™” - ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // ëª¨ë“  NOTAM í‘œì‹œ
                showAllNotams();
            }
        });

        // ì ìš© ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('applyFilterBtn').addEventListener('click', function() {
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('resetFilterBtn').addEventListener('click', function() {
            // ì‹œê°„ ì…ë ¥ê°’ ì´ˆê¸°í™”
            document.getElementById('startDate').value = '{{ current_date }}';
            document.getElementById('endDate').value = '{{ current_date }}';
            document.getElementById('startTime').value = '06:00';
            document.getElementById('endTime').value = '08:00';
            
            // í•„í„°ë§ì´ ì¼œì ¸ ìˆìœ¼ë©´ ì ìš©
            if (document.getElementById('timeFilterSwitch').checked) {
                applyTimeFilter();
            }
        });

        // Enter í‚¤ë¡œë„ í•„í„° ì ìš© ê°€ëŠ¥
        ['startDate', 'endDate', 'startTime', 'endTime'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('applyFilterBtn').click();
                }
            });
        });

        function applyTimeFilter() {
            if (!document.getElementById('timeFilterSwitch').checked) {
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            console.log('í•„í„° ì…ë ¥ê°’:', { startDate, endDate, startTime, endTime });

            if (!startDate || !endDate || !startTime || !endTime) {
                alert('ëª¨ë“  ì‹œê°„ í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const filterStart = new Date(startDate + 'T' + startTime);
            const filterEnd = new Date(endDate + 'T' + endTime);
            
            console.log('í•„í„° ë²”ìœ„:', filterStart, '~', filterEnd);

            let visibleCount = 0;
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('ì´ NOTAM ìˆ˜:', notamItems.length);

            notamItems.forEach((item, index) => {
                const effectiveTime = item.dataset.effectiveTime;
                const expiryTime = item.dataset.expiryTime;
                
                console.log(`NOTAM ${index + 1} ì›ë³¸ ì‹œê°„:`, { 
                    effectiveTime, 
                    expiryTime,
                    hasEffective: !!effectiveTime,
                    hasExpiry: !!expiryTime,
                    isUFN: expiryTime === 'UFN'
                });
                
                let isVisible = true;
                
                // ì‹¤ì œ ì‹œê°„ í•„í„°ë§ ë¡œì§
                if (effectiveTime && expiryTime && effectiveTime !== 'UFN' && expiryTime !== 'UFN') {
                    try {
                        // NOTAM ì‹œê°„ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜
                        let notamStart, notamEnd;
                        
                        console.log(`NOTAM ${index + 1} ì›ë³¸ ë°ì´í„°:`, { effectiveTime, expiryTime });
                        
                        // UTC ì‹œê°„ì„ ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ
                        if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamStart = new Date(effectiveTime);
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            // UTC ì—†ëŠ” ISO í˜•ì‹ì€ UTCë¡œ ì²˜ë¦¬
                            notamStart = new Date(effectiveTime + 'Z');
                        } else if (effectiveTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            // 2025-07-09 16:00 í˜•ì‹ì„ UTCë¡œ ì²˜ë¦¬
                            notamStart = new Date(effectiveTime.replace(' ', 'T') + ':00Z');
                        } else {
                            // ê¸°íƒ€ í˜•ì‹
                            notamStart = new Date(effectiveTime);
                        }
                        
                        if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z/)) {
                            notamEnd = new Date(expiryTime);
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime + 'Z');
                        } else if (expiryTime.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}/)) {
                            notamEnd = new Date(expiryTime.replace(' ', 'T') + ':00Z');
                        } else {
                            notamEnd = new Date(expiryTime);
                        }
                        
                        if (!isNaN(notamStart.getTime()) && !isNaN(notamEnd.getTime())) {
                            // SmartNOTAMgemini_GCR ë°©ì‹: ê²¹ì¹¨ í™•ì¸
                            // ê²¹ì¹˜ëŠ” ì¡°ê±´: notamStart <= filterEnd && notamEnd >= filterStart
                            const isOverlapping = notamStart <= filterEnd && notamEnd >= filterStart;
                            isVisible = isOverlapping;
                            
                            console.log(`NOTAM ${index + 1} ì‹œê°„ ë¶„ì„ (ë¡œì»¬):`, {
                                notamStart: notamStart.toLocaleString(),
                                notamEnd: notamEnd.toLocaleString(),
                                filterStart: filterStart.toLocaleString(),
                                filterEnd: filterEnd.toLocaleString(),
                                isOverlapping: isOverlapping,
                                visible: isVisible
                            });
                        } else {
                            console.warn(`NOTAM ${index + 1} ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨:`, {
                                effectiveTime,
                                expiryTime,
                                notamStart: isNaN(notamStart.getTime()) ? 'Invalid' : notamStart.toISOString(),
                                notamEnd: isNaN(notamEnd.getTime()) ? 'Invalid' : notamEnd.toISOString()
                            });
                            isVisible = true;  // íŒŒì‹± ì‹¤íŒ¨ì‹œ í‘œì‹œ
                        }
                    } catch (e) {
                        // íŒŒì‹± ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ í‘œì‹œ
                        console.warn('ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜:', e, 'effectiveTime:', effectiveTime, 'expiryTime:', expiryTime);
                        isVisible = true;
                    }
                } else {
                    console.log(`NOTAM ${index + 1}: ì‹œê°„ ì •ë³´ ë¶€ì¡± ë˜ëŠ” UFN`, { effectiveTime, expiryTime });
                }

                // ê°œë³„ NOTAM ì¹´ë“œ í‘œì‹œ/ìˆ¨ê¹€
                if (isVisible) {
                    item.style.display = 'block';
                    const statusBadge = item.querySelector('.notam-status');
                    const category = statusBadge.dataset.category || 'OTHER';
                    const categoryIcon = statusBadge.dataset.categoryIcon || 'ğŸ“„';
                    const categoryColor = statusBadge.dataset.categoryColor || '#6c757d';
                    const categoryBgColor = statusBadge.dataset.categoryBgColor || '#e9ecef';
                    
                    statusBadge.innerHTML = `${categoryIcon} ${category}`;
                    statusBadge.dataset.category = category;
                    statusBadge.style.backgroundColor = categoryBgColor;
                    statusBadge.style.color = categoryColor;
                    statusBadge.style.border = `1px solid ${categoryColor}`;
                    statusBadge.className = 'badge float-end notam-status';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
                
                // í†µí•© íƒ­ ì„¹ì…˜ì˜ í•´ë‹¹ NOTAM í•­ëª©ë“¤ë„ í•„í„°ë§
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = isVisible ? 'block' : 'none';
                });
            });

            const totalNotams = notamItems.length;
            
            // í•„í„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
            const filterStatusContent = document.getElementById('filterStatusContent');
            if (filterStatusContent) {
                filterStatusContent.innerHTML = 
                    `í•„í„°ë§ ê²°ê³¼: <strong style="color: #dc3545;">${visibleCount}ê°œ</strong> NOTAMì´ ì‹œê°„ ë²”ìœ„ì— í¬í•¨ë¨ (ì „ì²´: ${totalNotams}ê°œ)`;
            }
            
            // í†µí•© íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('summaryFilterStatus').textContent = 
                `ì‹œê°„ í•„í„°ë§ í™œì„±: ${visibleCount}ê°œ NOTAMë§Œ í‘œì‹œ ì¤‘`;
        }

        function showAllNotams() {
            const notamItems = document.querySelectorAll('.notam-item');
            notamItems.forEach((item, index) => {
                item.style.display = 'block';
                const statusBadge = item.querySelector('.notam-status');
                const category = statusBadge.dataset.category || 'OTHER';
                const categoryIcon = statusBadge.dataset.categoryIcon || 'ğŸ“„';
                const categoryColor = statusBadge.dataset.categoryColor || '#6c757d';
                const categoryBgColor = statusBadge.dataset.categoryBgColor || '#e9ecef';
                
                statusBadge.innerHTML = `${categoryIcon} ${category}`;
                statusBadge.dataset.category = category;
                statusBadge.style.backgroundColor = categoryBgColor;
                statusBadge.style.color = categoryColor;
                statusBadge.style.border = `1px solid ${categoryColor}`;
                statusBadge.className = 'badge float-end notam-status';
                
                // í†µí•© íƒ­ ì„¹ì…˜ì˜ ëª¨ë“  NOTAM í•­ëª©ë„ í‘œì‹œ
                const notamIndex = index + 1;
                const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                summaryItems.forEach(summaryItem => {
                    summaryItem.style.display = 'block';
                });
            });

            const totalNotams = notamItems.length;
            
            // í•„í„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
            const filterStatusContent = document.getElementById('filterStatusContent');
            if (filterStatusContent) {
                filterStatusContent.innerHTML = 
                    `ì „ì²´ NOTAM: <strong style="color: #198754;">${totalNotams}ê°œ</strong> (ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±í™” - ëª¨ë“  NOTAM í‘œì‹œ)`;
            }
            
            // í†µí•© íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('summaryFilterStatus').textContent = 
                `ì‹œê°„ í•„í„°ë§ ë¹„í™œì„±: ì „ì²´ ${totalNotams}ê°œ NOTAM í‘œì‹œ ì¤‘`;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ NOTAM ë°ì´í„° í™•ì¸
        document.addEventListener('DOMContentLoaded', function() {
            // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ê³µí•­ ì½”ë“œ ì‚¬ìš©
            const airportCodes = [
                {% for notam in notams %}
                    {% if notam.airport_code %}'{{ notam.airport_code }}',{% endif %}
                {% endfor %}
            ];
            
            // ì¤‘ë³µ ì œê±° ë° ì •ë ¬
            const uniqueAirports = [...new Set(airportCodes)].sort();
            console.log('ì¶”ì¶œëœ ê³µí•­ ì½”ë“œ:', uniqueAirports);
            
            // í•„í„°ë§ ìƒíƒœ ì´ˆê¸°í™”
            initializeFilterStatus();
            
            // ê³µí•­ í•„í„° ì´ˆê¸°í™” (íŒ¨í‚¤ì§€ë³„ ê³µí•­ í•„í„°ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ)
            const packageAirports = {{ package_airports|tojson|safe if package_airports else 'null' }};
            if (!packageAirports) {
                if (uniqueAirports.length > 0) {
                    renderAirportFilter(uniqueAirports);
                } else {
                    document.getElementById('airportFilter').innerHTML = 
                        '<div class="text-muted">ì‚¬ìš© ê°€ëŠ¥í•œ ê³µí•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } else {
                // íŒ¨í‚¤ì§€ë³„ ê³µí•­ í•„í„°ê°€ ìˆëŠ” ê²½ìš° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë§Œ ì„¤ì •
                setupAirportFilterListeners();
            }
            
            // ë””ë²„ê¹…: ëª¨ë“  NOTAM ì•„ì´í…œì˜ ì‹œê°„ ë°ì´í„° ì¶œë ¥
            const notamItems = document.querySelectorAll('.notam-item');
            console.log('=== NOTAM ì‹œê°„ ë°ì´í„° ë””ë²„ê¹… ===');
            notamItems.forEach((item, index) => {
                console.log(`NOTAM ${index + 1}:`, {
                    effectiveTime: item.dataset.effectiveTime,
                    expiryTime: item.dataset.expiryTime,
                    rawHTML: item.outerHTML.substring(0, 200) + '...'
                });
            });
            console.log('=== ë””ë²„ê¹… ì™„ë£Œ ===');
            
            // ì‹œê°„ í•„í„°ë§ ìŠ¤ìœ„ì¹˜ ìƒíƒœì— ë”°ë¼ ì´ˆê¸°í™”
            const timeFilterSwitch = document.getElementById('timeFilterSwitch');
            const timeFilterCard = document.querySelector('.time-filter-controls .card');
            const applyBtn = document.getElementById('applyFilterBtn');
            
            if (timeFilterSwitch.checked) {
                // í•„í„°ë§ì´ ì¼œì ¸ ìˆìœ¼ë©´ ì¹´ë“œ í™œì„±í™”
                timeFilterCard.classList.remove('disabled');
                timeFilterCard.style.opacity = '1';
                applyBtn.disabled = false;
                
                document.getElementById('filterStatus').textContent = 
                    `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ì‹œê°„ í•„í„° ì„¤ì • í›„ 'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)`;
                document.getElementById('summaryFilterStatus').textContent = 
                    `ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ê³  'ì ìš©' ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í•„í„°ë§í•˜ì„¸ìš”`;
                
                // ëª¨ë“  NOTAMì„ ì´ˆê¸° ìƒíƒœë¡œ í‘œì‹œ
                const notamItems = document.querySelectorAll('.notam-item');
                notamItems.forEach((item, index) => {
                    item.style.display = 'block';
                    item.querySelector('.notam-status').textContent = 'ëŒ€ê¸°ì¤‘';
                    item.querySelector('.notam-status').className = 'badge bg-warning float-end notam-status';
                    
                    // í†µí•© íƒ­ ì„¹ì…˜ë„ í‘œì‹œ
                    const notamIndex = index + 1;
                    const summaryItems = document.querySelectorAll(`[data-notam-index="${notamIndex}"]`);
                    summaryItems.forEach(summaryItem => {
                        summaryItem.style.display = 'block';
                    });
                });
            } else {
                // í•„í„°ë§ì´ êº¼ì ¸ ìˆìœ¼ë©´ ì¹´ë“œ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
                timeFilterCard.classList.add('disabled');
                timeFilterCard.style.opacity = '0.6';
                applyBtn.disabled = true;
                
                // ëª¨ë“  NOTAM í‘œì‹œ
                showAllNotams();
            }

            // ë£¨íŠ¸ ë¶„ì„ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            document.getElementById('analyzeRouteBtn').addEventListener('click', function() {
                analyzeRoute();
            });

            document.getElementById('clearRouteBtn').addEventListener('click', function() {
                clearRoute();
            });

            document.getElementById('routeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    analyzeRoute();
                }
            });
        });

        // ê³µí•­ í•„í„° UI ë Œë”ë§
        function renderAirportFilter(airports) {
            const airportFilterContainer = document.getElementById('airportFilter');
            
            const checkboxes = airports.map(airport => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input airport-checkbox" type="checkbox" 
                           id="airport_${airport}" value="${airport}" checked>
                    <label class="form-check-label" for="airport_${airport}">
                        ${airport}
                    </label>
                </div>
            `).join('');

            airportFilterContainer.innerHTML = checkboxes;

            // ê³µí•­ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            setupAirportFilterListeners();
        }

        // ê³µí•­ í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupAirportFilterListeners() {
            // ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
            document.getElementById('selectAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = true);
            });

            document.getElementById('clearAllAirports').addEventListener('click', function() {
                const checkboxes = document.querySelectorAll('.airport-checkbox');
                checkboxes.forEach(checkbox => checkbox.checked = false);
            });

            // í•„í„° ì ìš© ë²„íŠ¼
            document.getElementById('applyAirportFilter').addEventListener('click', function() {
                applyAirportFilter();
            });
        }

        // ê³µí•­ í•„í„° ì ìš© í•¨ìˆ˜
        function applyAirportFilter() {
            const selectedAirports = Array.from(document.querySelectorAll('.airport-checkbox:checked'))
                .map(checkbox => checkbox.value);

            console.log('ì„ íƒëœ ê³µí•­:', selectedAirports);

            const notamItems = document.querySelectorAll('.notam-item');
            const notamSummaryItems = document.querySelectorAll('.notam-summary-item');
            let visibleCount = 0;

            // ê°œë³„ NOTAM ì¹´ë“œ í•„í„°ë§
            notamItems.forEach((item, index) => {
                // NOTAMì—ì„œ ê³µí•­ ì½”ë“œ ì¶”ì¶œ (bg-info ë°°ì§€ ì‚¬ìš©)
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const notamAirports = Array.from(airportBadges).map(badge => badge.textContent.trim());

                console.log(`NOTAM ${index + 1} ê³µí•­:`, notamAirports);

                // ì„ íƒëœ ê³µí•­ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                const hasMatchingAirport = notamAirports.some(airport => selectedAirports.includes(airport));

                if (selectedAirports.length === 0 || hasMatchingAirport) {
                    item.style.display = 'block';
                    visibleCount++;
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸ - ì¹´í…Œê³ ë¦¬ ì •ë³´ ìœ ì§€
                    const statusBadge = item.querySelector('.notam-status');
                    // ì›ë˜ ì¹´í…Œê³ ë¦¬ ì •ë³´ë¥¼ ìœ ì§€í•˜ë˜ í‘œì‹œ ìƒíƒœë§Œ ë³€ê²½
                    const originalCategory = statusBadge.dataset.category || 'OTHER';
                    const categoryIcon = statusBadge.dataset.categoryIcon || 'ğŸ“„';
                    const categoryColor = statusBadge.dataset.categoryColor || '#6c757d';
                    const categoryBgColor = statusBadge.dataset.categoryBgColor || '#e9ecef';
                    
                    statusBadge.innerHTML = `${categoryIcon} ${originalCategory}`;
                    statusBadge.style.backgroundColor = categoryBgColor;
                    statusBadge.style.color = categoryColor;
                    statusBadge.style.border = `1px solid ${categoryColor}`;
                    statusBadge.className = 'badge float-end notam-status';
                } else {
                    item.style.display = 'none';
                    
                    // ìƒíƒœ ì—…ë°ì´íŠ¸
                    const statusBadge = item.querySelector('.notam-status');
                    statusBadge.textContent = 'í•„í„°ë¨';
                    statusBadge.className = 'badge bg-secondary float-end notam-status';
                }
            });

            // ì „ì²´ ë²ˆì—­/ìš”ì•½ íƒ­ì˜ NOTAM í•­ëª© í•„í„°ë§
            notamSummaryItems.forEach((item, index) => {
                const airportCode = item.getAttribute('data-airport-code');
                
                console.log(`Summary NOTAM ${index + 1} ê³µí•­:`, airportCode);

                if (selectedAirports.length === 0 || selectedAirports.includes(airportCode)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // ìƒíƒœ ì—…ë°ì´íŠ¸
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusContent = document.getElementById('filterStatusContent');
            
            if (selectedAirports.length === 0) {
                filterStatusContent.innerHTML = `ì „ì²´ NOTAM: ${totalNotams}ê°œ (ê³µí•­ í•„í„° ì—†ìŒ - ëª¨ë“  NOTAM í‘œì‹œ)`;
            } else {
                filterStatusContent.innerHTML = `
                    í•„í„°ë§ ê²°ê³¼: <strong style="color: #dc3545;">${visibleCount}ê°œ</strong> NOTAMì´ ì„ íƒëœ ê³µí•­ì— í¬í•¨ë¨ (ì „ì²´: ${totalNotams}ê°œ)<br>
                    <strong>ì„ íƒëœ ê³µí•­:</strong> ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')}
                `;
            }

            // ì „ì²´ ë²ˆì—­/ìš”ì•½ íƒ­ ìƒíƒœ ì—…ë°ì´íŠ¸
            const summaryFilterStatus = document.getElementById('summaryFilterStatus');
            if (selectedAirports.length === 0) {
                summaryFilterStatus.textContent = 'ëª¨ë“  ê³µí•­ì˜ NOTAMì´ í‘œì‹œë©ë‹ˆë‹¤.';
            } else {
                const visibleSummaryCount = document.querySelectorAll('.notam-summary-item[style*="display: block"], .notam-summary-item:not([style*="display: none"])').length;
                summaryFilterStatus.innerHTML = `
                    ì„ íƒëœ ê³µí•­: ${selectedAirports.map(airport => 
                        `<span class="badge bg-primary me-1">${airport}</span>`
                    ).join('')} - ${visibleSummaryCount}ê°œ NOTAM í‘œì‹œ ì¤‘
                `;
            }

            console.log(`ê³µí•­ í•„í„° ì ìš© ì™„ë£Œ: ${visibleCount}ê°œ NOTAM í‘œì‹œ`);
        }

        // êµ¬ê¸€ì§€ë„ ìƒˆ ì°½ ì—´ê¸°
        function openGoogleMaps() {
            window.open('/google_maps', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        }

        // ë£¨íŠ¸ ë¶„ì„ ê´€ë ¨ í•¨ìˆ˜ë“¤

        function analyzeRoute() {
            const routeInput = document.getElementById('routeInput').value.trim();
            
            if (!routeInput) {
                alert('í•­ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const analyzeBtn = document.getElementById('analyzeRouteBtn');
            const originalText = analyzeBtn.innerHTML;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>AI ë¶„ì„ ì¤‘...';
            analyzeBtn.disabled = true;

            // AI ê¸°ë°˜ ë£¨íŠ¸ ë¶„ì„
            performAIRouteAnalysis(routeInput)
                .then(result => {
                    displayAIRouteAnalysis(result);
                })
                .catch(error => {
                    console.error('AI ë¶„ì„ ì˜¤ë¥˜:', error);
                    // í´ë°±: ê¸°ì¡´ ë¶„ì„ ë°©ì‹ ì‚¬ìš©
                    const analysisResult = performRouteAnalysis(routeInput);
                    displayRouteAnalysis(analysisResult);
                })
                .finally(() => {
                    // ë²„íŠ¼ ìƒíƒœ ë³µì›
                    analyzeBtn.innerHTML = originalText;
                    analyzeBtn.disabled = false;
                });
        }

        async function performAIRouteAnalysis(route) {
            try {
                // í˜„ì¬ í˜ì´ì§€ì˜ NOTAM ë°ì´í„° ìˆ˜ì§‘
                const notamData = collectCurrentNotamData();
                
                const response = await fetch('/api/analyze_route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        route: route,
                        notam_data: notamData
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('AI ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                throw error;
            }
        }

        function collectCurrentNotamData() {
            const notamItems = document.querySelectorAll('.notam-item');
            const notamData = [];
            
            console.log('=== collectCurrentNotamData ë””ë²„ê¹… ===');
            console.log('ì°¾ì€ NOTAM ì•„ì´í…œ ìˆ˜:', notamItems.length);
            
            notamItems.forEach((item, index) => {
                // NOTAM ë²ˆí˜¸ ì¶”ì¶œ (card-titleì—ì„œ)
                const notamNumber = item.querySelector('.card-title')?.textContent?.trim() || `NOTAM_${index + 1}`;
                
                // ê³µí•­ ì½”ë“œ ì¶”ì¶œ (bg-info ë°°ì§€)
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const airports = Array.from(airportBadges).map(badge => badge.textContent.trim());
                
                // NOTAM í…ìŠ¤íŠ¸ ì¶”ì¶œ (translation-textì—ì„œ)
                const notamText = item.querySelector('.translation-text')?.textContent?.trim() || '';
                const description = item.querySelector('.notam-description')?.textContent?.trim() || '';
                
                // ì‹œê°„ ì •ë³´ ì¶”ì¶œ
                const effectiveTime = item.getAttribute('data-effective-time') || '';
                const expiryTime = item.getAttribute('data-expiry-time') || '';
                
                console.log(`NOTAM ${index + 1}:`, {
                    notamNumber,
                    airports,
                    textLength: notamText.length,
                    descriptionLength: description.length,
                    effectiveTime,
                    expiryTime
                });
                
                // ğŸ” ì‹¤ì œ NOTAM í…ìŠ¤íŠ¸ êµ¬ì¡° í™•ì¸ (ì²˜ìŒ 5ì¤„ë§Œ)
                if (notamText) {
                    const lines = notamText.split('\n');
                    console.log(`NOTAM ${index + 1} í…ìŠ¤íŠ¸ êµ¬ì¡° (ì²˜ìŒ 5ì¤„):`);
                    for (let i = 0; i < Math.min(5, lines.length); i++) {
                        console.log(`  ì¤„ ${i + 1}: '${lines[i]}'`);
                    }
                }
                
                notamData.push({
                    index: index + 1,
                    notam_number: notamNumber,
                    airports: airports,
                    text: notamText,
                    description: description,
                    effective_time: effectiveTime,
                    expiry_time: expiryTime
                });
            });
            
            // ì›ë³¸ NOTAM í…ìŠ¤íŠ¸ ì €ì¥ (ê³µí•­ ì •ë³´ ì¶”ì¶œìš©)
            if (notamData.length > 0) {
                const fullNotamText = notamData.map(notam => notam.text).join('\n');
                window.originalNotamText = fullNotamText;
                console.log('ì›ë³¸ NOTAM í…ìŠ¤íŠ¸ ì €ì¥:', fullNotamText.length, 'ë¬¸ì');
                
                // ğŸ” ì „ì²´ NOTAM í…ìŠ¤íŠ¸ êµ¬ì¡° í™•ì¸ (ì²˜ìŒ 10ì¤„ë§Œ)
                const lines = fullNotamText.split('\n');
                console.log('=== ì „ì²´ NOTAM í…ìŠ¤íŠ¸ êµ¬ì¡° (ì²˜ìŒ 10ì¤„) ===');
                for (let i = 0; i < Math.min(10, lines.length); i++) {
                    console.log(`ì¤„ ${i + 1}: '${lines[i]}'`);
                }
            } else {
                console.log('âš ï¸ NOTAM ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            return notamData;
        }

        function displayAIRouteAnalysis(result) {
            const resultDiv = document.getElementById('routeAnalysisResult');
            const contentDiv = document.getElementById('routeAnalysisContent');
            
            // FIR ê¸°ë°˜ ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ (ë¹„í™œì„±í™”)
            let firAnalysisHtml = '';
            
            // AI ë¶„ì„ ê²°ê³¼ë¥¼ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
            const formattedAnalysis = formatMarkdownToHTML(result.gemini_analysis || result.analysis || '');
            
            contentDiv.innerHTML = `
                ${firAnalysisHtml}
                <div class="alert alert-success mb-3">
                    <h5 class="alert-heading">ğŸ¤– AI ê¸°ë°˜ í•­ë¡œ ë¶„ì„ ê²°ê³¼</h5>
                    <p class="mb-0"><strong>ë¶„ì„ í•­ë¡œ:</strong> ${result.route}</p>
                    <small class="text-muted">ë¶„ì„ ì‹œê°„: ${new Date(result.timestamp).toLocaleString()}</small>
                </div>
                <div class="ai-analysis-content">
                    ${formattedAnalysis}
                </div>
            `;
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function formatMarkdownToHTML(markdown) {
            // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
            return markdown
                .replace(/^## (.*$)/gim, '<h4 class="mt-4 mb-3">$1</h4>')
                .replace(/^### (.*$)/gim, '<h5 class="mt-3 mb-2">$1</h5>')
                .replace(/^\- (.*$)/gim, '<li>$1</li>')
                .replace(/^\d+\. (.*$)/gim, '<li>$1</li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^(?!<[h|l])/gm, '<p>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '');
        }

        function performRouteAnalysis(route) {
            // ì…ë ¥ëœ ë£¨íŠ¸ì—ì„œ ì£¼ìš” ì§€ì ë“¤ ì¶”ì¶œ
            const routePoints = extractRoutePoints(route);
            
            // í˜„ì¬ NOTAM ë°ì´í„°ì—ì„œ ê´€ë ¨ NOTAM ì°¾ê¸°
            const relevantNotams = findRelevantNotams(routePoints);
            
            // ë¶„ì„ ê²°ê³¼ ìƒì„±
            return {
                route: route,
                routePoints: routePoints,
                relevantNotams: relevantNotams,
                analysis: generateRouteAnalysis(relevantNotams)
            };
        }

        function extractRoutePoints(route) {
            // ë£¨íŠ¸ì—ì„œ ì£¼ìš” ì§€ì ë“¤ ì¶”ì¶œ (ê³µí•­ ì½”ë“œ, í•­ë¡œ ì§€ì  ë“±)
            const points = [];
            
            // ê³µí•­ ì½”ë“œ íŒ¨í„´ (4ê¸€ì ëŒ€ë¬¸ì)
            const airportPattern = /\b([A-Z]{4})\b/g;
            let match;
            while ((match = airportPattern.exec(route)) !== null) {
                points.push({
                    type: 'airport',
                    code: match[1],
                    position: match.index
                });
            }

            // í•­ë¡œ ì§€ì  íŒ¨í„´ (3-5ê¸€ì ëŒ€ë¬¸ì)
            const waypointPattern = /\b([A-Z]{3,5})\b/g;
            while ((match = waypointPattern.exec(route)) !== null) {
                // ê³µí•­ ì½”ë“œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ì¶”ê°€
                if (!points.some(p => p.code === match[1])) {
                    points.push({
                        type: 'waypoint',
                        code: match[1],
                        position: match.index
                    });
                }
            }

            return points;
        }

        function findRelevantNotams(routePoints) {
            const relevantNotams = [];
            const notamItems = document.querySelectorAll('.notam-item');
            
            notamItems.forEach((item, index) => {
                const notamText = item.querySelector('.notam-text').textContent;
                const airportBadges = item.querySelectorAll('.badge.bg-info');
                const notamAirports = Array.from(airportBadges).map(badge => badge.textContent.trim());
                
                // ë£¨íŠ¸ ì§€ì ê³¼ ê´€ë ¨ëœ NOTAM ì°¾ê¸°
                let isRelevant = false;
                let relevanceReasons = [];

                // ê³µí•­ ì½”ë“œ ë§¤ì¹­
                routePoints.forEach(point => {
                    if (point.type === 'airport' && notamAirports.includes(point.code)) {
                        isRelevant = true;
                        relevanceReasons.push(`ê³µí•­ ${point.code} ê´€ë ¨`);
                    }
                });

                // í•­ë¡œ ì§€ì  ë§¤ì¹­
                routePoints.forEach(point => {
                    if (point.type === 'waypoint' && notamText.includes(point.code)) {
                        isRelevant = true;
                        relevanceReasons.push(`í•­ë¡œ ì§€ì  ${point.code} ê´€ë ¨`);
                    }
                });

                // íŠ¹ì • í‚¤ì›Œë“œ ë§¤ì¹­ (GPS, RAIM, FLOW CTL ë“±)
                const keywords = ['GPS', 'RAIM', 'FLOW CTL', 'RADAR', 'VOR', 'DME', 'NDB'];
                keywords.forEach(keyword => {
                    if (notamText.includes(keyword)) {
                        isRelevant = true;
                        relevanceReasons.push(`${keyword} ê´€ë ¨`);
                    }
                });

                if (isRelevant) {
                    relevantNotams.push({
                        index: index + 1,
                        notamNumber: item.querySelector('td').textContent,
                        airports: notamAirports,
                        text: notamText.substring(0, 200) + '...',
                        relevanceReasons: relevanceReasons
                    });
                }
            });

            return relevantNotams;
        }

        function generateRouteAnalysis(relevantNotams) {
            if (relevantNotams.length === 0) {
                return "ì…ë ¥ëœ í•­ë¡œì™€ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ëœ NOTAMì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }

            // Package 3 ê³µí•­ë“¤ì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
            const packageAirports = {{ package_airports|tojson|safe if package_airports else 'null' }};
            const package3Airports = packageAirports && packageAirports.package3 ? packageAirports.package3 : [];
            
            // Package 3 ê´€ë ¨ NOTAMë§Œ í•„í„°ë§
            const package3Notams = relevantNotams.filter(notam => {
                return notam.airports.some(airport => package3Airports.includes(airport));
            });

            let analysis = `<strong>Package 3 ê´€ë ¨ NOTAM ìƒì„¸ ë¶„ì„</strong><br><br>`;
            analysis += `<div class="alert alert-primary mb-3">
                <strong>ğŸ“‹ ë¶„ì„ ëŒ€ìƒ ê³µí•­:</strong> ${package3Airports.join(', ')}<br>
                <strong>ğŸ›£ï¸ í•­ë¡œ:</strong> ${document.getElementById('routeInput').value}
            </div>`;

            if (package3Notams.length === 0) {
                analysis += `<div class="alert alert-warning">
                    <strong>âš ï¸ ì£¼ì˜:</strong> Package 3 ê³µí•­ë“¤ê³¼ ì§ì ‘ì ìœ¼ë¡œ ê´€ë ¨ëœ NOTAMì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                </div>`;
                return analysis;
            }

            analysis += `ì œì‹œëœ í•­ë¡œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê²€í† í–ˆì„ ë•Œ, ì•„ë˜ NOTAMë“¤ì´ í•´ë‹¹ë©ë‹ˆë‹¤.<br><br>`;

            // NOTAMë³„ ìƒì„¸ ë¶„ì„
            package3Notams.forEach((notam, index) => {
                const notamText = notam.text.toLowerCase();
                const notamNumber = notam.notamNumber;
                const airports = notam.airports.join(', ');
                
                analysis += `<div class="card mb-3">`;
                analysis += `<div class="card-header">`;
                analysis += `<h6 class="mb-0">NOTAM #${notam.index} (${notamNumber})</h6>`;
                analysis += `<small class="text-muted">ê´€ë ¨ ê³µí•­: ${airports}</small>`;
                analysis += `</div>`;
                analysis += `<div class="card-body">`;

                // NOTAM ë‚´ìš©ì— ë”°ë¥¸ ìƒì„¸ ë¶„ì„
                if (notamText.includes('flow ctl') || notamText.includes('sadli')) {
                    analysis += `<div class="alert alert-info">
                        <strong>âœ… í•´ë‹¹:</strong> ì´ í•­ë¡œëŠ” í•œêµ­(RKSI)ì—ì„œ ì¶œë°œí•˜ì—¬ ì¤‘êµ­ ì˜ê³µì„ í†µê³¼í•©ë‹ˆë‹¤. 
                        NOTAMì— ëª…ì‹œëœ SADLI ì§€ì ì€ í•­ë¡œì— ì§ì ‘ í¬í•¨ë˜ì§€ ì•Šë”ë¼ë„, 
                        ì¸ì²œê³¼ ìƒí•˜ì´ ACC ê°„ì˜ ì£¼ìš” ê´€ì œ ì´ê´€ ì§€ì ì´ë¯€ë¡œ í•­ë¡œìƒì—ì„œ ê´€ì œ ì´ì–‘ ì ˆì°¨ê°€ ì ìš©ë  ê°€ëŠ¥ì„±ì´ ë§¤ìš° ë†’ìŠµë‹ˆë‹¤.
                    </div>`;
                } else if (notamText.includes('gps') || notamText.includes('raim')) {
                    analysis += `<div class="alert alert-warning">
                        <strong>âœ… í•´ë‹¹:</strong> ì´ë¥™ ê³µí•­ì´ RKSI(ì¸ì²œ)ì´ë¯€ë¡œ, ë¹„í–‰ ì´ˆë°˜ì— ì¸ì²œ FIR ë‚´ì—ì„œ GPS ì‹ í˜¸ ë¶ˆì•ˆì • í˜„ìƒì„ ê²ªì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                        ë¹„í–‰ ì¤‘ GPS ì‹ í˜¸ì—ë§Œ ì˜ì¡´í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>`;
                } else if (notamText.includes('bopta') || notamText.includes('ponik')) {
                    analysis += `<div class="alert alert-warning">
                        <strong>âœ… í•´ë‹¹:</strong> ì´ í•­ë¡œëŠ” BOPTA ì§€ì ì—ì„œ ì‹œì‘ë©ë‹ˆë‹¤. 
                        ì´ NOTAMì€ BOPTAì—ì„œ PONIKê¹Œì§€ì˜ ì¡°ê±´ë¶€ í•­ë¡œ(CDR2)ì— ëŒ€í•œ ë‚´ìš©ì´ë¯€ë¡œ, 
                        ë¹„í–‰ ê³„íšì— ë”°ë¼ í•´ë‹¹ í•­ë¡œë¥¼ ì‚¬ìš©í•œë‹¤ë©´ ëª…ì‹œëœ ì‹œê°„ ë° ê³ ë„ ì œí•œì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>`;
                } else if (notamText.includes('eastbound') || notamText.includes('ikeka')) {
                    analysis += `<div class="alert alert-secondary">
                        <strong>âŒ í•´ë‹¹ ì—†ìŒ:</strong> ì´ NOTAMì€ ìƒí•˜ì´ì—ì„œ ì¸ì²œìœ¼ë¡œ ì§„ì…í•˜ëŠ” ë™ìª½í–‰(Eastbound) í•­ê³µê¸°ì— ëŒ€í•œ ì§€ì¹¨ì…ë‹ˆë‹¤. 
                        ì¶œë°œì§€ RKSIì—ì„œ ëª©ì ì§€ VVDNìœ¼ë¡œ í–¥í•˜ëŠ” ë¹„í–‰ì€ ë°©í–¥ì´ ë‹¤ë¥´ë¯€ë¡œ ì´ NOTAMì€ í•´ë‹¹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </div>`;
                } else if (notamText.includes('frng') || notamText.includes('firing') || notamText.includes('prohibited')) {
                    analysis += `<div class="alert alert-danger">
                        <strong>âœ… í•´ë‹¹:</strong> ëª©ì ì§€ VVDN(ë‹¤ë‚­)ì€ ë² íŠ¸ë‚¨ì— ìœ„ì¹˜í•´ ìˆìŠµë‹ˆë‹¤. 
                        ì´ í•­ë¡œëŠ” ë² íŠ¸ë‚¨ ì˜ê³µì„ í†µê³¼í•˜ê²Œ ë˜ë¯€ë¡œ, 
                        <strong>í›ˆë ¨ êµ¬ì—­ì˜ ì¢Œí‘œì™€ ê³ ë„(3,200í”¼íŠ¸/4,500í”¼íŠ¸)</strong>ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•˜ì—¬ 
                        í•­ë¡œê°€ í›ˆë ¨ êµ¬ì—­ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
                    </div>`;
                } else if (notamText.includes('vor') || notamText.includes('dme') || notamText.includes('ndb')) {
                    analysis += `<div class="alert alert-info">
                        <strong>â„¹ï¸ ì •ë³´:</strong> í•­ë¡œìƒì˜ í•­í–‰ ë³´ì¡° ì‹œì„¤ ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤. 
                        í•´ë‹¹ ì‹œì„¤ì˜ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ëŒ€ì²´ ì ˆì°¨ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.
                    </div>`;
                } else if (notamText.includes('radar') || notamText.includes('ads-b')) {
                    analysis += `<div class="alert alert-info">
                        <strong>â„¹ï¸ ì •ë³´:</strong> ê´€ì œ ì„œë¹„ìŠ¤ ê´€ë ¨ ì •ë³´ì…ë‹ˆë‹¤. 
                        í•´ë‹¹ êµ¬ì—­ì—ì„œì˜ ê´€ì œ ì ˆì°¨ì™€ ìš”êµ¬ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.
                    </div>`;
                } else {
                    analysis += `<div class="alert alert-light">
                        <strong>ğŸ“‹ ì¼ë°˜ ì •ë³´:</strong> í•­ë¡œ ê³„íš ì‹œ ì°¸ê³ í•  ì¼ë°˜ì ì¸ ì •ë³´ì…ë‹ˆë‹¤.
                    </div>`;
                }

                analysis += `<div class="mt-2">
                    <small class="text-muted">
                        <strong>NOTAM ë‚´ìš©:</strong> ${notam.text.substring(0, 150)}...
                    </small>
                </div>`;

                analysis += `</div></div>`;
            });

            // ìµœì¢… ìš”ì•½ í…Œì´ë¸”
            analysis += `<div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">ğŸ“Š ìµœì¢… ìš”ì•½</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>NOTAM ë²ˆí˜¸</th>
                                <th>ì£¼ìš” ë‚´ìš©</th>
                                <th>ROUTE ê´€ë ¨ ì—¬ë¶€</th>
                            </tr>
                        </thead>
                        <tbody>`;

            package3Notams.forEach(notam => {
                const notamText = notam.text.toLowerCase();
                let relevance = '';
                let relevanceClass = '';

                if (notamText.includes('flow ctl') || notamText.includes('sadli')) {
                    relevance = 'ê´€ì œ ì´ì–‘ ì§€ì  í™•ì¸ í•„ìš”';
                    relevanceClass = 'table-info';
                } else if (notamText.includes('gps') || notamText.includes('raim')) {
                    relevance = 'RKSI ì¶œë°œì´ë¯€ë¡œ í•´ë‹¹';
                    relevanceClass = 'table-warning';
                } else if (notamText.includes('bopta') || notamText.includes('ponik')) {
                    relevance = 'BOPTA ì§€ì  í¬í•¨';
                    relevanceClass = 'table-warning';
                } else if (notamText.includes('eastbound') || notamText.includes('ikeka')) {
                    relevance = 'í•´ë‹¹ ì—†ìŒ (ë°©í–¥ì´ ë‹¤ë¦„)';
                    relevanceClass = 'table-secondary';
                } else if (notamText.includes('frng') || notamText.includes('firing')) {
                    relevance = 'ë² íŠ¸ë‚¨ ì˜ê³µ í†µê³¼';
                    relevanceClass = 'table-danger';
                } else {
                    relevance = 'ì •ë³´ì„± NOTAM';
                    relevanceClass = 'table-light';
                }

                analysis += `<tr class="${relevanceClass}">
                    <td>NOTAM #${notam.index} (${notam.notamNumber})</td>
                    <td>${notam.text.substring(0, 80)}...</td>
                    <td>${relevance}</td>
                </tr>`;
            });

            analysis += `</tbody></table>
                </div>
            </div>`;

            // ê¶Œì¥ì‚¬í•­
            analysis += `<div class="alert alert-success mt-3">
                <h6 class="alert-heading">ğŸ¯ ê¶Œì¥ì‚¬í•­</h6>
                <ul class="mb-0">
                    <li>ì¤‘ìš”ë„ê°€ ë†’ì€ NOTAMë“¤ì„ ìš°ì„ ì ìœ¼ë¡œ ê²€í† í•˜ì„¸ìš”.</li>
                    <li>í•­ë¡œìƒì˜ ê° ì§€ì ë³„ë¡œ í•´ë‹¹ NOTAMì˜ ì˜í–¥ì„ í‰ê°€í•˜ì„¸ìš”.</li>
                    <li>ëŒ€ì²´ í•­ë¡œë‚˜ ì ˆì°¨ê°€ í•„ìš”í•œì§€ í™•ì¸í•˜ì„¸ìš”.</li>
                    <li>íŠ¹íˆ ë² íŠ¸ë‚¨ ì˜ê³µì˜ ì‚¬ê²© í›ˆë ¨ êµ¬ì—­ì„ ë°˜ë“œì‹œ íšŒí”¼í•˜ì„¸ìš”.</li>
                </ul>
            </div>`;

            return analysis;
        }

        function displayRouteAnalysis(result) {
            const resultDiv = document.getElementById('routeAnalysisResult');
            const contentDiv = document.getElementById('routeAnalysisContent');
            
            contentDiv.innerHTML = result.analysis;
            resultDiv.style.display = 'block';
            
            // ê²°ê³¼ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearRoute() {
            document.getElementById('routeInput').value = '';
            document.getElementById('routeAnalysisResult').style.display = 'none';
        }

        // HTML ì €ì¥ ê¸°ëŠ¥
        function saveAsHTML() {
            // í˜„ì¬ í˜ì´ì§€ì˜ ì „ì²´ HTMLì„ ê°€ì ¸ì˜¤ê¸°
            const htmlContent = document.documentElement.outerHTML;
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì €ì¥ ì¤‘...';
            saveBtn.disabled = true;
            
            // ì„œë²„ì— HTML ì €ì¥ ìš”ì²­
            fetch('/save_html', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    html_content: htmlContent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showAlert('success', `HTML íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.filename}`);
                    
                    // ë‹¤ìš´ë¡œë“œ ë§í¬ ì œê³µ
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `/download_html/${data.filename}`;
                    downloadLink.download = data.filename;
                    downloadLink.click();
                } else {
                    showAlert('danger', `ì €ì¥ ì‹¤íŒ¨: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('HTML ì €ì¥ ì˜¤ë¥˜:', error);
                showAlert('danger', 'HTML ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        function showAlert(type, message) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function initializeFilterStatus() {
            // í˜„ì¬ í‘œì‹œëœ NOTAM ê°œìˆ˜ ê³„ì‚°
            const visibleNotams = document.querySelectorAll('.notam-item:not([style*="display: none"])');
            const totalNotams = document.querySelectorAll('.notam-item').length;
            
            // í•„í„°ë§ ìƒíƒœ ì—…ë°ì´íŠ¸
            const filterStatusContent = document.getElementById('filterStatusContent');
            if (filterStatusContent) {
                filterStatusContent.innerHTML = `ì „ì²´ NOTAM: <strong style="color: #198754;">${totalNotams}ê°œ</strong> (í˜„ì¬ ${visibleNotams.length}ê°œ í‘œì‹œ ì¤‘)`;
            }
        }
        
        // NOTAM ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        function getNotamData() {
            try {
                // í˜ì´ì§€ì˜ NOTAM ë°ì´í„° ìˆ˜ì§‘
                const notamItems = document.querySelectorAll('.notam-item');
                const notamData = [];
                
                notamItems.forEach((item, index) => {
                    // NOTAM ë²ˆí˜¸ ì¶”ì¶œ
                    const notamNumber = item.querySelector('.card-title')?.textContent?.trim() || `NOTAM_${index + 1}`;
                    
                    // ê³µí•­ ì½”ë“œ ì¶”ì¶œ (bg-info ë°°ì§€)
                    const airportBadges = item.querySelectorAll('.badge.bg-info');
                    const airports = Array.from(airportBadges).map(badge => badge.textContent.trim());
                    
                    // NOTAM í…ìŠ¤íŠ¸ ì¶”ì¶œ
                    const text = item.querySelector('.translation-text')?.textContent?.trim() || '';
                    const description = item.querySelector('.notam-description')?.textContent?.trim() || '';
                    
                    // ì‹œê°„ ì •ë³´ ì¶”ì¶œ
                    const effectiveTime = item.getAttribute('data-effective-time') || '';
                    const expiryTime = item.getAttribute('data-expiry-time') || '';
                    
                    notamData.push({
                        index: index + 1,
                        notam_number: notamNumber,
                        airports: airports,
                        text: text,
                        description: description,
                        effective_time: effectiveTime,
                        expiry_time: expiryTime
                    });
                });
                
                console.log(`getNotamData: ${notamData.length}ê°œ NOTAM ìˆ˜ì§‘`);
                return notamData;
            } catch (error) {
                console.error('getNotamData ì˜¤ë¥˜:', error);
                return [];
            }
        }
        
        // ê³µí•­ë³„ NOTAM ë¶„ì„ ë²„íŠ¼ ì²˜ë¦¬
        document.getElementById('startAirportAnalysisBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ë¶„ì„ ì¤‘...';
            btn.disabled = true;
            
            // ì¶”ì¶œëœ ê³µí•­ ì •ë³´ ì‚¬ìš© (UI ì…ë ¥ í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ì¶”ì¶œëœ ì •ë³´ ì‚¬ìš©)
            let dep = document.getElementById('editDep')?.value?.trim() || '';
            let dest = document.getElementById('editDest')?.value?.trim() || '';
            let altn = document.getElementById('editAltn')?.value?.trim() || '';
            let refile = document.getElementById('editRefile')?.value?.trim() || '';
            let edto = document.getElementById('editEdto')?.value?.trim() || '';
            
            console.log('=== ê³µí•­ ì •ë³´ ìˆ˜ì§‘ ë””ë²„ê¹… ===');
            console.log('UI ì…ë ¥ í•„ë“œ ê°’ë“¤:', { dep, dest, altn, refile, edto });
            console.log('editDep ìš”ì†Œ:', document.getElementById('editDep'));
            console.log('editDep ê°’:', document.getElementById('editDep')?.value);
            console.log('editDest ìš”ì†Œ:', document.getElementById('editDest'));
            console.log('editDest ê°’:', document.getElementById('editDest')?.value);
            
            // UI ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ì¶”ì¶œëœ ì •ë³´ ì‚¬ìš©
            if (!dep || !dest) {
                const flightInfo = window.extractedFlightInfo;
                console.log('window.extractedFlightInfo:', flightInfo);
                if (flightInfo) {
                    dep = dep || flightInfo.dep || '';
                    dest = dest || flightInfo.dest || '';
                    altn = altn || flightInfo.altn || '';
                    refile = refile || flightInfo.refile || '';
                    edto = edto || flightInfo.edto || '';
                    console.log('ìë™ ì¶”ì¶œëœ ê³µí•­ ì •ë³´ ì‚¬ìš©:', { dep, dest, altn, refile, edto });
                }
            } else {
                console.log('UIì—ì„œ ê°€ì ¸ì˜¨ ê³µí•­ ì •ë³´:', { dep, dest, altn, refile, edto });
            }
            
            if (!dep || !dest) {
                showAirportAnalysisError('DEP(ì¶œë°œ)ê³¼ DEST(ëª©ì ì§€) ê³µí•­ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            
            const data = {
                dep: dep,
                dest: dest,
                altn: altn || null,
                edto: edto || null,
                notam_data: window.currentNotamData || getNotamData()
            };
            
            
            try {
                const response = await fetch('/api/analyze_airports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayAirportAnalysisResult(result);
                } else {
                    const error = await response.json();
                    showAirportAnalysisError(error.error || 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê³µí•­ë³„ NOTAM ë¶„ì„ ì˜¤ë¥˜:', error);
                showAirportAnalysisError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // AI ì¢…í•© ë¶„ì„ ë²„íŠ¼ ì²˜ë¦¬
        document.getElementById('comprehensiveAnalysisBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>AI ë¶„ì„ ì¤‘...';
            btn.disabled = true;
            
            // ì¶”ì¶œëœ ê³µí•­ ì •ë³´ ì‚¬ìš© (UI ì…ë ¥ í•„ë“œ ìš°ì„ , ì—†ìœ¼ë©´ ìë™ ì¶”ì¶œëœ ì •ë³´ ì‚¬ìš©)
            let dep = document.getElementById('editDep')?.value?.trim() || '';
            let dest = document.getElementById('editDest')?.value?.trim() || '';
            let altn = document.getElementById('editAltn')?.value?.trim() || '';
            let refile = document.getElementById('editRefile')?.value?.trim() || '';
            let edto = document.getElementById('editEdto')?.value?.trim() || '';
            
            console.log('=== AI ë¶„ì„ ê³µí•­ ì •ë³´ ìˆ˜ì§‘ ë””ë²„ê¹… ===');
            console.log('UI ì…ë ¥ í•„ë“œ ê°’ë“¤:', { dep, dest, altn, refile, edto });
            console.log('editDep ìš”ì†Œ:', document.getElementById('editDep'));
            console.log('editDep ê°’:', document.getElementById('editDep')?.value);
            console.log('editDest ìš”ì†Œ:', document.getElementById('editDest'));
            console.log('editDest ê°’:', document.getElementById('editDest')?.value);
            
            // UI ì…ë ¥ í•„ë“œê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ì¶”ì¶œëœ ì •ë³´ ì‚¬ìš©
            if (!dep || !dest) {
                const flightInfo = window.extractedFlightInfo;
                console.log('window.extractedFlightInfo:', flightInfo);
                if (flightInfo) {
                    dep = dep || flightInfo.dep || '';
                    dest = dest || flightInfo.dest || '';
                    altn = altn || flightInfo.altn || '';
                    refile = refile || flightInfo.refile || '';
                    edto = edto || flightInfo.edto || '';
                    console.log('AI ë¶„ì„ - ìë™ ì¶”ì¶œëœ ê³µí•­ ì •ë³´ ì‚¬ìš©:', { dep, dest, altn, refile, edto });
                }
            } else {
                console.log('AI ë¶„ì„ - UIì—ì„œ ê°€ì ¸ì˜¨ ê³µí•­ ì •ë³´:', { dep, dest, altn, refile, edto });
            }
            
            if (!dep || !dest) {
                showAirportAnalysisError('DEP(ì¶œë°œ)ê³¼ DEST(ëª©ì ì§€) ê³µí•­ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            
            const data = {
                dep: dep,
                dest: dest,
                altn: altn || null,
                edto: edto || null,
                notam_data: window.currentNotamData || getNotamData()
            };
            
            
            try {
                const response = await fetch('/api/analyze_airports_comprehensive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayComprehensiveAnalysisResult(result);
                } else {
                    const error = await response.json();
                    showAirportAnalysisError(error.error || 'AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('AI ì¢…í•© ë¶„ì„ ì˜¤ë¥˜:', error);
                showAirportAnalysisError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // ê³µí•­ë³„ NOTAM ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAirportAnalysisResult(result) {
            const resultDiv = document.getElementById('airportAnalysisResult');
            const contentDiv = document.getElementById('airportAnalysisContent');
            
            // ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼ì„ ìœ„í•œ ê²€ì¦
            if (!result || !result.analysis_result || !result.analysis_result.summary) {
                console.error('ë¶„ì„ ê²°ê³¼ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', result);
                showAirportAnalysisError('ë¶„ì„ ê²°ê³¼ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            const analysis = result.analysis_result;
            const summary = analysis.summary;
            
            // ì•ˆì „í•œ ë°°ì—´ ì ‘ê·¼
            const criticalAirports = summary.critical_airports || [];
            const totalAirports = summary.total_airports || 0;
            const totalNotams = summary.total_notams || 0;
            const overallStatus = summary.overall_status || 'UNKNOWN';
            
            let html = `
                <div class="alert alert-info">
                    <h6 class="alert-heading">ğŸ“Š ì „ì²´ ìš”ì•½</h6>
                    <p class="mb-2">
                        <strong>ë¶„ì„ ê³µí•­:</strong> ${totalAirports}ê°œ | 
                        <strong>ì´ NOTAM:</strong> ${totalNotams}ê°œ | 
                        <strong>ìƒíƒœ:</strong> 
                        <span class="badge ${overallStatus === 'CRITICAL' ? 'bg-danger' : 'bg-success'}">
                            ${overallStatus === 'CRITICAL' ? 'ğŸš¨ ì£¼ì˜ í•„ìš”' : 'âœ… ì •ìƒ'}
                        </span>
                    </p>
                    ${criticalAirports.length > 0 ? 
                        `<p class="mb-0"><strong>ì£¼ì˜ ê³µí•­:</strong> ${criticalAirports.join(', ')}</p>` : 
                        '<p class="mb-0">ëª¨ë“  ê³µí•­ì´ ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤.</p>'
                    }
                </div>
            `;
            
            // ê° ê³µí•­ë³„ ë¶„ì„ ê²°ê³¼
            const airports = analysis.airports || {};
            Object.entries(airports).forEach(([airportType, airportData]) => {
                // ì•ˆì „í•œ ë°ì´í„° ì ‘ê·¼
                const airportCode = airportData?.airport_code || 'N/A';
                const totalNotams = airportData?.total_notams || 0;
                const priorityCounts = airportData?.priority_summary?.counts || {};
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-plane me-2"></i>
                                ${airportType} - ${airportCode}
                                <span class="badge bg-primary ms-2">${totalNotams}ê°œ NOTAM</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6>ğŸ“‹ ë¶„ì„ ìš”ì•½</h6>
                                    <div class="mb-2">${(airportData?.analysis || 'ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.').replace(/\n/g, '<br>')}</div>
                                    
                                    ${(airportData?.key_issues || []).length > 0 ? `
                                        <h6>ğŸš¨ ì£¼ìš” ì´ìŠˆ</h6>
                                        <ul class="list-unstyled">
                                            ${(airportData.key_issues || []).map(issue => `<li>${issue}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                    
                                    <h6>ğŸ’¡ ê¶Œì¥ì‚¬í•­</h6>
                                    <ul class="list-unstyled">
                                        ${(airportData?.recommendations || ['ê¶Œì¥ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.']).map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h6>ğŸ“Š ìš°ì„ ìˆœìœ„ë³„ ë¶„í¬</h6>
                                    ${priorityCounts.critical > 0 ? `<div class="mb-1"><span class="badge bg-danger">Critical: ${priorityCounts.critical}</span></div>` : ''}
                                    ${priorityCounts.high > 0 ? `<div class="mb-1"><span class="badge bg-warning">High: ${priorityCounts.high}</span></div>` : ''}
                                    ${priorityCounts.medium > 0 ? `<div class="mb-1"><span class="badge bg-info">Medium: ${priorityCounts.medium}</span></div>` : ''}
                                    ${priorityCounts.low > 0 ? `<div class="mb-1"><span class="badge bg-secondary">Low: ${priorityCounts.low}</span></div>` : ''}
                                    
                                    <h6 class="mt-3">ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ë¶„í¬</h6>
                                    ${Object.entries(airportData.categories).filter(([cat, notams]) => notams.length > 0).map(([cat, notams]) => 
                                        `<div class="mb-1"><span class="badge bg-light text-dark">${cat}: ${notams.length}</span></div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // AI ì¢…í•© ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayComprehensiveAnalysisResult(result) {
            const resultDiv = document.getElementById('airportAnalysisResult');
            const contentDiv = document.getElementById('airportAnalysisContent');
            
            const analysis = result.analysis_result;
            const summary = analysis.summary;
            
            let html = `
                <div class="alert alert-info">
                    <h6 class="alert-heading">ğŸ¤– AI ì¢…í•© ë¶„ì„ ê²°ê³¼ (GEMINI)</h6>
                    <p class="mb-2">
                        <strong>ë¶„ì„ ê³µí•­:</strong> ${summary.total_airports}ê°œ | 
                        <strong>ì´ NOTAM:</strong> ${summary.total_notams}ê°œ | 
                        <strong>ë¶„ì„ ë°©ì‹:</strong> ${summary.analysis_type}
                    </p>
                </div>
            `;
            
            // ê° ê³µí•­ë³„ ì¢…í•© ë¶„ì„ ê²°ê³¼
            Object.entries(airports).forEach(([airportType, airportData]) => {
                const airportCode = airportData?.airport_code || 'N/A';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-brain me-2"></i>
                                ${airportType} - ${airportCode} (AI ì¢…í•© ë¶„ì„)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <h6>ğŸ“‹ AI ë¶„ì„ ìš”ì•½</h6>
                                    <div class="mb-3">${airportData?.summary || 'AI ë¶„ì„ ìš”ì•½ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                                    
                                    ${(airportData?.critical_issues || []).length > 0 ? `
                                        <h6>ğŸš¨ Critical ì´ìŠˆ</h6>
                                        <div class="mb-3">
                                            ${(airportData.critical_issues || []).map(issue => `
                                                <div class="alert alert-danger mb-2">
                                                    <strong>${issue?.category || 'N/A'}:</strong> ${issue?.issue || 'N/A'}<br>
                                                    <small><strong>ì˜í–¥:</strong> ${issue?.impact || 'N/A'}</small><br>
                                                    <small><strong>ì°¸ì¡°:</strong> ${(issue?.notam_refs || []).join(', ')}</small>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${(airportData?.approach_landing_guidance || []).length > 0 ? `
                                        <h6>ğŸ›¬ ì ‘ê·¼ ë° ì°©ë¥™ ê°€ì´ë“œ</h6>
                                        <div class="mb-3">
                                            ${(airportData.approach_landing_guidance || []).map(guide => `
                                                <div class="card mb-2">
                                                    <div class="card-body">
                                                        <h6 class="card-title">${guide?.runway || 'N/A'} - ${guide?.approach_type || 'N/A'}</h6>
                                                        <p class="card-text"><strong>ì œí•œì‚¬í•­:</strong> ${guide?.restrictions || 'N/A'}</p>
                                                        <p class="card-text"><strong>ê¶Œì¥ì‚¬í•­:</strong> ${guide?.recommendations || 'N/A'}</p>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${airportData.ground_operations && airportData.ground_operations.length > 0 ? `
                                        <h6>ğŸ›¬ ì§€ìƒìš´ì˜ ê°€ì´ë“œ</h6>
                                        <div class="mb-3">
                                            ${airportData.ground_operations.map(ops => `
                                                <div class="card mb-2">
                                                    <div class="card-body">
                                                        <h6 class="card-title">${ops.area}</h6>
                                                        <p class="card-text"><strong>ì œí•œì‚¬í•­:</strong> ${ops.restrictions}</p>
                                                        <p class="card-text"><strong>ëŒ€ì•ˆ:</strong> ${ops.alternatives}</p>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${airportData.recommendations && airportData.recommendations.length > 0 ? `
                                        <h6>ğŸ’¡ AI ê¶Œì¥ì‚¬í•­</h6>
                                        <ul class="list-unstyled">
                                            ${airportData.recommendations.map(rec => `<li class="mb-1">â€¢ ${rec}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                    
                                    ${airportData.gemini_analysis ? `
                                        <h6>ğŸ¤– GEMINI AI ì›ë³¸ ë¶„ì„</h6>
                                        <div class="alert alert-light">
                                            <pre style="white-space: pre-wrap; font-size: 0.9em;">${airportData.gemini_analysis}</pre>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ê³µí•­ë³„ NOTAM ë¶„ì„ ì˜¤ë¥˜ í‘œì‹œ
        function showAirportAnalysisError(message) {
            const resultDiv = document.getElementById('airportAnalysisResult');
            const contentDiv = document.getElementById('airportAnalysisContent');
            
            contentDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6 class="alert-heading">âŒ ë¶„ì„ ì˜¤ë¥˜</h6>
                    <p class="mb-0">${message}</p>
                </div>
            `;
            
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ê³µí•­ ì •ë³´ ì¶”ì¶œ
        async function autoExtractFlightInfo() {
            try {
                console.log('=== ê³µí•­ ì •ë³´ ìë™ ì¶”ì¶œ ì‹œì‘ ===');
                
                // NOTAM í…ìŠ¤íŠ¸ ìˆ˜ì§‘
                if (!window.originalNotamText) {
                    console.log('NOTAM í…ìŠ¤íŠ¸ ìˆ˜ì§‘ ì¤‘...');
                    collectCurrentNotamData(); // NOTAM í…ìŠ¤íŠ¸ ìˆ˜ì§‘
                }
                
                const notamText = window.originalNotamText || '';
                console.log('NOTAM í…ìŠ¤íŠ¸:', notamText ? `${notamText.length} ë¬¸ì` : 'ì—†ìŒ');
                
                if (!notamText) {
                    console.log('NOTAM í…ìŠ¤íŠ¸ê°€ ì—†ì–´ì„œ ê³µí•­ ì •ë³´ ì¶”ì¶œì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                    return;
                }
                
                console.log('API í˜¸ì¶œ ì‹œì‘...');
                
                const response = await fetch('/api/extract_flight_info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        notam_text: notamText
                    })
                });
                
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('ê³µí•­ ì •ë³´ ì¶”ì¶œ ì„±ê³µ:', result.flight_info);
                    
                    // ì¶”ì¶œëœ ì •ë³´ë¥¼ í‘œì‹œ ì˜ì—­ì— í‘œì‹œ
                    displayExtractedAirportInfo(result.flight_info);
                    
                    // ì¶”ì¶œ ì„±ê³µ ì•Œë¦¼
                    showExtractionSuccess(result.flight_info);
                } else {
                    const errorText = await response.text();
                    console.error('ê³µí•­ ì •ë³´ ì¶”ì¶œ API ì˜¤ë¥˜:', response.status, errorText);
                    
                    // ì˜¤ë¥˜ ì•Œë¦¼ í‘œì‹œ
                    showExtractionError(`API ì˜¤ë¥˜ (${response.status}): ${errorText}`);
                }
            } catch (error) {
                console.error('ê³µí•­ ì •ë³´ ìë™ ì¶”ì¶œ ì˜¤ë¥˜:', error);
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì•Œë¦¼ í‘œì‹œ
                showExtractionError(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
            }
        }
        
        // ì¶”ì¶œ ì˜¤ë¥˜ ì•Œë¦¼ í‘œì‹œ
        function showExtractionError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show extraction-alert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '400px';
            
            alertDiv.innerHTML = `
                <h6 class="alert-heading">âš ï¸ ê³µí•­ ì •ë³´ ì¶”ì¶œ ì˜¤ë¥˜</h6>
                <p class="mb-2">${message}</p>
                <p class="mb-0">ìˆ˜ë™ìœ¼ë¡œ ê³µí•­ ì •ë³´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 10000);
        }
        
        // ì¶”ì¶œëœ ê³µí•­ ì •ë³´ í‘œì‹œ
        function displayExtractedAirportInfo(flightInfo) {
            console.log('=== displayExtractedAirportInfo ë””ë²„ê¹… ===');
            console.log('ë°›ì€ flightInfo:', flightInfo);
            
            // í‘œì‹œ ì˜ì—­ í‘œì‹œ
            const displayDiv = document.getElementById('extractedAirportInfo');
            console.log('extractedAirportInfo div:', displayDiv);
            if (displayDiv) {
                displayDiv.style.display = 'block';
            }
            
            // ê° ê³µí•­ ì •ë³´ë¥¼ ì…ë ¥ í•„ë“œì— ìë™ ì±„ìš°ê¸°
            const depField = document.getElementById('editDep');
            const destField = document.getElementById('editDest');
            const altnField = document.getElementById('editAltn');
            const refileField = document.getElementById('editRefile');
            const edtoField = document.getElementById('editEdto');
            
            console.log('ì…ë ¥ í•„ë“œë“¤:', { depField, destField, altnField, refileField, edtoField });
            
            if (flightInfo.dep && depField) {
                depField.value = flightInfo.dep;
                console.log('DEP ì„¤ì •:', flightInfo.dep);
            }
            if (flightInfo.dest && destField) {
                destField.value = flightInfo.dest;
                console.log('DEST ì„¤ì •:', flightInfo.dest);
            }
            if (flightInfo.altn && altnField) {
                altnField.value = flightInfo.altn;
                console.log('ALTN ì„¤ì •:', flightInfo.altn);
            }
            if (flightInfo.refile && refileField) {
                refileField.value = flightInfo.refile;
                console.log('REFILE ì„¤ì •:', flightInfo.refile);
            }
            if (flightInfo.edto && edtoField) {
                edtoField.value = flightInfo.edto;
                console.log('EDTO ì„¤ì •:', flightInfo.edto);
            }
            
            console.log('ì„¤ì • í›„ ê°’ë“¤:', {
                dep: depField?.value,
                dest: destField?.value,
                altn: altnField?.value,
                refile: refileField?.value,
                edto: edtoField?.value
            });
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ë¶„ì„ ë²„íŠ¼ì—ì„œ ì‚¬ìš©)
            window.extractedFlightInfo = flightInfo;
        }
        
        // ì¶”ì¶œ ì„±ê³µ ì•Œë¦¼ í‘œì‹œ
        function showExtractionSuccess(flightInfo) {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingAlert = document.querySelector('.extraction-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // ì„±ê³µ ì•Œë¦¼ ìƒì„±
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show extraction-alert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '400px';
            
            let extractedInfo = [];
            if (flightInfo.dep) extractedInfo.push(`DEP: ${flightInfo.dep}`);
            if (flightInfo.dest) extractedInfo.push(`DEST: ${flightInfo.dest}`);
            if (flightInfo.altn) extractedInfo.push(`ALTN: ${flightInfo.altn}`);
            if (flightInfo.refile) extractedInfo.push(`REFILE: ${flightInfo.refile}`);
            if (flightInfo.edto) extractedInfo.push(`EDTO: ${flightInfo.edto}`);
            
            alertDiv.innerHTML = `
                <h6 class="alert-heading">âœ¨ ê³µí•­ ì •ë³´ ìë™ ì¶”ì¶œ ì™„ë£Œ</h6>
                <p class="mb-2">NOTAMì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤:</p>
                <p class="mb-0"><strong>${extractedInfo.join(' | ')}</strong></p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // ì¶”ì¶œëœ í•­ê³µí¸ ì •ë³´ í‘œì‹œ ë° ì…ë ¥ í•„ë“œ ìë™ ì±„ìš°ê¸°
        function displayExtractedFlightInfo(flightInfo) {
            const resultDiv = document.getElementById('airportAnalysisResult');
            const contentDiv = document.getElementById('airportAnalysisContent');
            
            // ì…ë ¥ í•„ë“œ ìë™ ì±„ìš°ê¸°
            if (flightInfo.dep) {
                document.getElementById('depAirport').value = flightInfo.dep;
            }
            if (flightInfo.dest) {
                document.getElementById('destAirport').value = flightInfo.dest;
            }
            if (flightInfo.altn) {
                document.getElementById('altnAirport').value = flightInfo.altn;
            }
            if (flightInfo.refile) {
                document.getElementById('refileAirport').value = flightInfo.refile;
            }
            if (flightInfo.edto) {
                document.getElementById('edtoAirport').value = flightInfo.edto;
            }
            
            // ì¶”ì¶œ ê²°ê³¼ í‘œì‹œ
            let html = `
                <div class="alert alert-success">
                    <h6 class="alert-heading">âœ¨ ê³µí•­ ì •ë³´ ìë™ ì¶”ì¶œ ì™„ë£Œ</h6>
                    <p class="mb-2">NOTAM í…ìŠ¤íŠ¸ì—ì„œ í•­ê³µí¸ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤.</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“‹ ì¶”ì¶œëœ ê³µí•­ ì •ë³´</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>DEP (ì¶œë°œ):</strong></td>
                                <td>${flightInfo.dep || 'ì¶”ì¶œë˜ì§€ ì•ŠìŒ'}</td>
                            </tr>
                            <tr>
                                <td><strong>DEST (ëª©ì ì§€):</strong></td>
                                <td>${flightInfo.dest || 'ì¶”ì¶œë˜ì§€ ì•ŠìŒ'}</td>
                            </tr>
                            <tr>
                                <td><strong>ALTN (ëŒ€ì²´):</strong></td>
                                <td>${flightInfo.altn || 'ì¶”ì¶œë˜ì§€ ì•ŠìŒ'}</td>
                            </tr>
                            <tr>
                                <td><strong>REFILE:</strong></td>
                                <td>${flightInfo.refile || 'ì¶”ì¶œë˜ì§€ ì•ŠìŒ'}</td>
                            </tr>
                            <tr>
                                <td><strong>EDTO:</strong></td>
                                <td>${flightInfo.edto || 'ì¶”ì¶œë˜ì§€ ì•ŠìŒ'}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ“Š ì¶”ì¶œ ì‹ ë¢°ë„</h6>
                        <div class="mb-2">
                            <small>DEP: ${(flightInfo.confidence.dep * 100).toFixed(0)}%</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${flightInfo.confidence.dep * 100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>DEST: ${(flightInfo.confidence.dest * 100).toFixed(0)}%</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${flightInfo.confidence.dest * 100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>ALTN: ${(flightInfo.confidence.altn * 100).toFixed(0)}%</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${flightInfo.confidence.altn * 100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>REFILE: ${(flightInfo.confidence.refile * 100).toFixed(0)}%</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${flightInfo.confidence.refile * 100}%"></div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <small>EDTO: ${(flightInfo.confidence.edto * 100).toFixed(0)}%</small>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" style="width: ${flightInfo.confidence.edto * 100}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (flightInfo.route) {
                html += `
                    <div class="mt-3">
                        <h6>ğŸ›« ì¶”ì¶œëœ í•­ë¡œ ì •ë³´</h6>
                        <div class="alert alert-light">
                            <code>${flightInfo.route}</code>
                        </div>
                    </div>
                `;
            }
            
            if (flightInfo.all_airports && flightInfo.all_airports.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>ğŸŒ ë°œê²¬ëœ ëª¨ë“  ê³µí•­</h6>
                        <div class="d-flex flex-wrap">
                            ${flightInfo.all_airports.map(airport => 
                                `<span class="badge bg-secondary me-1 mb-1">${airport}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (flightInfo.notam_details && flightInfo.notam_details.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>ğŸ“„ ê´€ë ¨ NOTAM ìƒì„¸</h6>
                        <div class="accordion" id="notamAccordion">
                            ${flightInfo.notam_details.map((detail, index) => `
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="heading${index}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                            NOTAM ${detail.notam_id} - ${detail.airports.join(', ')}
                                        </button>
                                    </h2>
                                    <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#notamAccordion">
                                        <div class="accordion-body">
                                            <small>
                                                DEP: ${detail.flight_info.dep || 'N/A'} | 
                                                DEST: ${detail.flight_info.dest || 'N/A'} | 
                                                ALTN: ${detail.flight_info.altn || 'N/A'} | 
                                                EDTO: ${detail.flight_info.edto || 'N/A'}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `
                <div class="mt-3">
                    <div class="alert alert-info">
                        <h6 class="alert-heading">ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„</h6>
                        <p class="mb-2">ì¶”ì¶œëœ ê³µí•­ ì •ë³´ê°€ ì…ë ¥ í•„ë“œì— ìë™ìœ¼ë¡œ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.</p>
                        <p class="mb-0">ì´ì œ <strong>"ê³µí•­ë³„ NOTAM ë¶„ì„ ì‹œì‘"</strong> ë˜ëŠ” <strong>"AI ì¢…í•© ë¶„ì„ (GEMINI)"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¶„ì„ì„ ì§„í–‰í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // ê²°ê³¼ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ìë™ ì¶”ì¶œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', function() {
            // ì•½ê°„ì˜ ì§€ì—° í›„ ìë™ ì¶”ì¶œ ì‹¤í–‰ (NOTAM ë°ì´í„° ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°)
            setTimeout(() => {
                autoExtractFlightInfo();
            }, 1000);
        });
    </script>
</body>
</html>